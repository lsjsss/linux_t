

# 云计算网络管理命令

## 配置Linux网络
### 配置静态主机名

> 配置文件/etc/hostname
>
> 固定保存的主机名，永久有效

```shell
echo "svr7.tedu.cn" > /etc/hostname
hostname svr7.tedu.cn
```

### 修改网卡命名规则

```shell
vim /etc/default/grub
    .........
    GRUB_CMDLINE_LINUX="..... quiet net.ifnames=0 biosdevname=0"
    ...........

grub2-mkconfig -o  /boot/grub2/grub.cfg #使网卡命名规则生效
reboot

ifconfig | head -2    #重启之后查看网卡名是不是eth0
```

### 配置静态IP地址

```shell
nmcli connection show   #查看网卡信息
nmcli connection delete ens33   #删除ens33网卡设备
nmcli connection show
nmcli connection delete 有线连接\ 1
nmcli connection show
nmcli connection add type ethernet ifname eth0 con-name eth0         #添加网卡设备eth0
nmcli connection show

#配置 eth0 的IP地址 （手动manual，自动auto） 为 192.168.4.10/24，网关为 192.168.4.254，开机后自动连接
nmcli connection modify eth0 ipv4.method manual ipv4.addresses 192.168.4.10/24 ipv4.gateway 192.168.4.254 connection.autoconnect yes

nmcli connection up eth0    #激活网卡
ifconfig | head -2
route -n    #查看网关
```

#### 通过修改配置文件的方式修改IP地址

```shell
vim /etc/sysconfig/network-scripts/ifcfg-eth0
    TYPE=Ethernet
    BOOTPROTO=static    #自动获取是dhcp，手动配置是static
    NAME=eth0
    DEVICE=eth0
    ONBOOT=yes
    IPADDR=192.168.4.25 #ip地址
    PREFIX=24   #子网掩码

systemctl restart network   #重启network网络服务
ifconfig | head -2
    eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
    inet 192.168.4.25  netmask 255.255.255.0  broadcast 192.168.4.255
```

### 为本机指定DNS服务器

> 配置文件   /etc/resolv.conf
>
> 关键记录：nameserver DNS服务器地址


```shell
vim /etc/resolv.conf
    # Generated by NetworkManager
    search tedu.cn
    nameserver 8.8.8.8

echo "nameserver 9.9.9.9" > /etc/resolv.conf
```

## 远程管理ssh
### SSH协议（Secure Shell）

> 为客户机提供安全的 Shell 环境
>
> 默认端口：**TCP22**


### OpenSSH 服务

> 服务名称：sshd
>
> 主程序：/use/sbin/sshd、/usr/bin/ssh
>
> 配置主件：/etc/ssh/sshd_config
>
> 	/etc/ssh/ssh_config

### SSH的基本使用

```shell
ssh root@要远程主机的ip地址	#远程指定的主机

ssh root@要使用图形界面远程主机的ip地址	#使用图形界面远程指定的主机
firefox	#测试图形界面状态下
```


## 使用scp远程复制工具
### 安全复制工具scp

```shell
scp -r 用户名@服务器:远程路径 本地路径	#将指定主机上的文件下载到本地
scp -r 本地路径 用户名@服务器:远程路径	#将本地的文件上上传至指定主机
```

```shell
scp -r root@192.168.4.207:/boot /opt/	#将远程主机.207的目录boot复制到本地opt目录下
scp -r /boot root@192.168.4.207:/opt/	#将本机的boot目录复制到远程主机.207主机的opt目录下
```


## 常用的网络工具
### 查看ip地址

```shell
ip address show
ip a s	#简写
```

### 添加ip地址

```shell
ip address add 192.168.8.1/24 dev ens33
ip aa
```

### 指定下一跳

```shell
vim /etc/rc.d/rc.local	#设置每次开机生效
	ip address add 192.168.8.1/24 dev ens33

ip route add 10.0.0.0/24 via 192.168.8.100 dev ens33	#添加路由，via是下一跳
ip route del 10.0.0.0/24	#删除路由表
ip route show	#查看路由表
```


### 查看对应的端口号
ss与netstat

选项列表：

> **-a**：显示所有端口的信息
>
> **-n**：以数字格式显示端口号
>
> **-t**：显示TCP连接的端口
>
> **-u**：显示UDP连接的端口
>
> **-l**：显示服务正在监听的端口信息
>
> **-p**：显示监听端口的服务名（程序名称）

```shell
netstat -anptu	#查看端口的详细信息
ss -antpu	#查看TCP端口号（相对全面）
netstat -anptu | grep :22	#筛选端口号为22的端口
ss -anptu | grep :22
```


### ping命令

```shell
ping -c 测试包的个数n 目标ip地址 #ping包n次
```

### Yum仓库特点
作为yum源需要准备的内容
大量的.rpm源需要准备的内容
针对这些软件包 **repodata/** 仓库档案


**repodata/**：仓库档案数据

> filelists.xml.gz	软件包的文件安装清单
>
> primary.xml.gz	软件包的基本/主要信息
>
> other.xml.gz	软件包的其他信息
>
> repomd.xml


### 结束后台进程

```shell
kill oneko	
```


### 源码编译安装的优势

主要优点

> 获得软件的最新版，及时修复bug
>
> 软件功能可按需选择/定制，有更多软件可供选择
>
> 源码包适用于各种平台

#### 安装开发工具gcc、make

```shell
yum -y install gcc make	#安装gcc、make包
rpm -q gcc	#检查是否安装成功
rpm -q make
tar -xf /opt/tools/inotify-tools-3.13.tar.gz -C /opt/
cd /opt/inotify-tools-3.13/
./confgure --help
./confgure --help --prefix=/opt/haha	#配置时指定安装位置
make	#编译
make install	#安装
ls /opt/haha/
ls /opt/haha/bin/
```


## SELinux运行模式的切换
### SELinux的运行模式

> enforcing（强制模式）
>
> permissive（宽松模式）
>
> disabled（彻底禁用）


### 切换运行模式
#### 临时切换：

```shell
getenforce	#查看SELinux当前的运行状态

setenforce 1	#切换至强制模式 1
setenforce 0	#切换至宽松模式 0
```

#### 永久改变SELinux的运行模式

> 固定配置：/etc/selinux/config 文件

```shell
vim /etc/selinux/config	#永久改变SELinux的运行模式
    SELINUX=disabled	#彻底禁用SELinux
    SELINUX=enabled	#彻底禁用SELinux
	
reboot	#重启查看状态
```


## 服务器架构

服务器：能够为其他服务器提供服务的更高级的电脑
>
>机架式
>
>塔式
>
>机柜室
>
>刀片式


### Client/Server架构

> 由服务器提供资源或某种功能
>
> 客户机使用资源或功能

### 搭建web（http）服务
#### 装包、起服务

1. 安装httpd（Apache）软件包（服务器软件）

    ```shell
    yum -y install httpd
    ```

2. 重起httpd服务

    ```shell
    systemctl start httpd
    ```

3. 访问测试，书写一个页面文件

    ```shell
    firefox http://192.168.4.10
    
    vim /var/www/html/index.html	#打开默认存放网页文件的路径进行编辑
    	<marquee><fount color=red><h1>I am king
    
    yum -y install elinks	#命令行浏览器
    
    elinks --dump http://192.168.4.10
    curl http://192.168.4.10	#命令行浏览器
    ```

##### 浏览页面

```shell
curl http://192.168.4.10	#命令行界面访问网站
elinks http://192.168.4.10	#命令行界面下的浏览器
elinks --dump http://192.168.4.10	#命令行界面直接浏览
```

### 搭建ftp服务
#### 装包、起服务
1. 安装vsftpd软件包

    ```shell
    yum -y install vsftpd
    ```

2. 启动vsftpd服务

    ```shell
    systemctl start vsftpd	#启动vsftpd服务
    systemctl restart vsftpd	#重起vsftpd服务
    ```

3. 访问测试

    ```shell
    firefox ftp://192.168.4.10
    touch /var/ftp/a.txt
    
    ls /var/ftp
    ```


## 防火墙
### Firewalld服务基础

> 系统服务：firewalld
>
> 管理工具：firewall-cmd、firewall-config


```shell
systemctl restart firewalld
firewall-config &
```


### 预设安全区域

根据所在的网络场所划分，预设保护规则集

> **public**：仅允许访问本机的sshd等少数几个服务（sshd、ping、dhcp）
>
> **trusted**：允许任何访问
>
> **block**：阻塞任何来访请求
>
> **drop**：丢弃任何来访的数据包

配置规则的位置

> 运行时（runtime）
>
> 永久（permanent）


```shell
#A机器
firewall-cmd --get-default-zone

#B机器
ping 192.168.4.10	可以ping通
curl http://192.168.4.10	#拒绝访问
curl ftp://192.168.4.10	#拒绝访问

#A机器
firewall-cmd --set-default-zone=trusted	#修改防火墙默认区域为trusted
firewall-cmd --get-default-zone

#B机器测试
ping 192.168.4.10	#可以ping通
curl http://192.168.4.10	#可以访问
curl ftp://192.168.4.10	#可以访问

#A机器
firewall-cmd --set-default-zone=block	#修改防火墙默认区域为block
firewall-cmd --get-default-zone

#B机器测试
ping 192.168.4.10	#不可以ping通，但是有回应

#A机器
firewall-cmd --set-default-zone=drop	#修改防火墙默认区域为drop
firewall-cmd --get-default-zone

#B机器测试
ping 192.168.4.10	#不可以ping通，但是有回应
```

## 互联网常见协议

| 名称       | 协议类型             | 默认端口 |
| ---------- | -------------------- | -------- |
| **http**   | 超文本传输协议       | 80       |
| **https**  | 安全的超文本传输协议 | 443      |
| **ftp**    | 文件传输协议         | 21       |
| **tftp**   | 简单的文件传输协议   | 69       |
| **DNS**    | 域名解析协议         | 53       |
| **telent** | 远程管理协议         | 23       |
| **smtp**   | 邮件协议（发送端口） | 25       |
| **pop3**   | 邮件协议（接收端口） | 110      |
| **snmp**   | 简单的网络管理协议   | 161      |



### 添加服务（临时）

```shell
firewall-cmd --zone=public --add-service=http	#启动http服务，设置允许http协议通过public区域（允许其他主机通过http访问）
firewall-cmd --zone=public --add-service=ftp	#启动ftp服务，设置允许ftp协议通过public区域（允许其他主机通过ftp访问）
firewall-cmd --zone=public --list-all	#查看区域策略（查看已启动的服务）

curl http://192.168.4.10	#在另一台主机上检测是否开启成功
curl ftp://192.168.4.10
```

### 添加服务（永久）
（永久设置允许ftp协议和http协议通过public区域（permanent：永久设置）开机自启）

```shell
firewall-cmd --permanent --zone=public --add-service=ftp	#永久启动ftp服务
firewall-cmd --permanent --zone=public --add-service=http	#永久启动http服务
firewall-cmd --reload    #重新加载配置文件
firewall-cmd --permanent --zone=public --list-all    #查看区域策略

netatat -anptu | grep :80    #过滤80端口
systemcli status httpd    #查看http服务状态
systemcli enable httpd    #设置http服务开机自启

curl ftp://192.168.4.10    #使用192.168.4.7主机检测，可以访问
curl http://192.168.4.10    #使用192.168.4.7主机检测，可以访问
```


### 服务的启动、重启、停止

```shell
systemcli enable httpd    #设置http服务开机自启
systemcli disable httpd    #设置http服务开机不自启

systemcli restart httpd    #重启http服务
systemcli stop httpd    #停止http服务
```

### 拒绝其他主机（指定ip，指定网络段）访问服务

```shell
firewall-cmd --zone=block --add-source=192.168.4.7    #拒绝192.168.4.7主机访问服务

curl ftp://192.168.4.10    #使用192.168.4.7主机检测，不可以访问
curl http://192.168.4.10    #使用192.168.4.7主机检测，不可以访问
```

### 恢复其他主机（移除列表中已指定ip，指定网络段）访问服务

```shell
firewall-cmd --zone=block --remove-source=192.168.4.7	#移除192.168.4.7主机，使其可以访问服务

curl ftp://192.168.4.10    #使用192.168.4.7主机检测，可以访问
curl http://192.168.4.10    #使用192.168.4.7主机检测，可以访问
```



## 部署网络 yum 源

>  服务端：利用 Web 服务或 FTP 服务共享光盘所有内容

### 利用 web（HTTP）服务共享

默认共享位置:/var/www/html/ 

> 服务端svr7操作
>
> ```shell
> yum -y install httpd
> systemctl start httpd
> systemctl status httpd #查看服务运行状态
> mkdir /var/www/html/dvd
> mount /dev/cdrom /var/www/html/dvd
> ls /var/www/html/dvd #查看是否有光盘内容
> firefox http://192.168.4.7/dvd #访问测试
> ```

>  客户端pc207操作
>
>  ```shell
>  vim /etc/yum.repos.d/dvd.repo
>  	[dvd]
>  	name=CentOS7.5
>  	baseurl=http://192.168.4.7/dvd
>  	enabled=1
>  	gpgcheck=0
>  yum clean all
>  yum repolist
>  yum -y install unzip
>  ```



### 利用 FTP 服务共享

默认共享位置：/var/ftp  

>  服务端svr7操作
>
>  ```shell
>  rpm -q vsftpd
>  systemctl start vsftpd
>  systemctl status vsftpd #查看服务运行状态
>  mkdir /var/ftp/dvd
>  mount /dev/cdrom /var/ftp/dvd
>  firefox ftp://192.168.4.7/dvd #访问测试
>  ```



> 客户端pc207操作
>
> ```shell
> vim /etc/yum.repos.d/dvd.repo
> 	[dvd]
> 	name=CentOS7.5
> 	baseurl=ftp://192.168.4.7/dvd
> 	enabled=1
> 	gpgcheck=0
> yum clean all
> yum repolist
> ```


## NPT（网络时间协议）时间同步
Network Time Protocol（网络时间协议）

> 用来同步网络中各个计算机的时间的协议
>
> 210.72.145.39（国家授时中心服务器IP地址）

Stratum（分层设计）

> Stratum层的总数限制在15层以内（包括15）

### 时间同步软件包

服务端（设置为时间同步服务器）：

```shell
yum -y install chrony
rpm -qc chrony	#查看配置文件（.conf结尾的文件）

vim /etc/chrony.conf
	server 0.centos.pool.ntp.org iburst	#网络标准时间服务器（快速同步）
	allow 192.168.4.0/24	#允许同步时间的主机网络段
	denv 192.168.4.1	#拒绝同步时间的主机网络段
	local statum 10	#访问层数
systemctl restart chronyd	#重启时间同步服务

setenforce 0
systemctl stop firewalld	#关闭防火墙
```

客户端（同步服务器上的时间）：

```shell
vim /etc/chrony.conf
	server 192.168.4.7 iburst	#指定要同步时间的服务器（192.168.4.7）
systemctl restart chronyd	#重启时间同步服务
chronyc sources -v	#验证时间是否同步成功
```


## Iscsi概述
### Internet SCSI，网际SCSI接口

> 一种基于C/S架构的虚拟磁盘技术
>
> 服务器提供磁盘空间，客户机连接并当成本地磁盘使用


### Iscsi磁盘的构成
backstore，后端存储
> 对应到服务端提供实际存储空间的设备，需要起一个管理名称

target，磁盘组
> 是客户端的访问目标，作为一个框架，由多个lun组成

lun，逻辑单元
> 每一个lun需要关联到某一个后端存储设备，在客户端会视为一块虚拟磁盘

### 使用targetcli建立配置（服务机svr7）

```shell
backstore/block create name=后端存储名 dev=实际设备路径	#创建后端存储
iscsi create 磁盘组的IQN名称	#IQN名称规范，创建磁盘组
iscsi/磁盘组名/tpql/luns create 后端存储路径	#创建关联
iscsi/磁盘组名/tpgl/acls create 客户机IQN标识
iscsi/磁盘组名/tpql/portals create IP地址 端口号
```

```shell
yum -y install targetcli	#安装服务软件包 targetcli
systemctl stop firewalld    #关闭防火墙
targetcli	#运行 targetcli 命令进行配置
	ls
	
	#创建后端存储
	backstores/block create dev=/dev/sdb1 name=nsd
	
	#创建磁盘组target，使用IQN名称规范
	iscsi/ create iqn.2019-09.cn.tedu:server
	
	#创建lun关联
	iscsi/iqn.2019-09.cn.tedu:server/tpg1/luns create /backstores/block/nsd
	
	#设置访问控制（acl），设置客户端的名称
	iscsi/iqn.2019-09.cn.tedu:server/tpg1/acls create iqn.2019-09.cn.tedu:client

	ls
	exit
systemctl restart target.service
```

#### IQN名称规范

`iqn.yyyy-mm.倒序域名`：自定义标识
用来识别target磁盘组，也用来识别客户机身份


### 使用targetcli建立配置（客户机pc207）

```shell
#安装客户端软件
yum -y install iscsi-initiator-utils
rpm -q iscsi-initiator-utils

#修改配置文件，指定客户端声称的名称
vim  /etc/iscsi/initiatorname.iscsi
	InitiatorName=iqn.2019-09.cn.tedu:client

#重起iscsid服务，仅仅是刷新客户端声称的名称
systemctl restart iscsid

#利用命令发现服务端共享存储
man iscsiadm	#查看iscsiadm帮助	/example按n向下匹配，按b向上匹配
iscsiadm --mode discoverydb --type sendtargets --portal 192.168.4.7 --discover

#重启iscsi服务（主服务），使用共享存储
systemctl restart iscsi
lsblk
```


## Web通信基本概念

> 基于B/S（Browser/Server）架构的网页服务
>
> 服务端提供网页
>
> 浏览器下载并显示网页

### 构建独立的web服务器

服务端

```shell
yum -y install httpd	#安装httpd软件包
echo abc > /var/www/html/index.html	#书写页面文件内容
systemctl restart httpd	#启动服务
```

客户端
```shell
curl http://192.168.4.7
```

### 提供的默认配置

> Listen：监听地址：端口80
>
> ServerName：本站点注册的DNS名称（空缺）
>
> DocumentRoot：网页根目录（/var/www/html）
>
> DirectoryIndex：起始页/首页文件名（index.html）


#### 修改http服务的默认路径
```shell
vim /etc/httpd/conf/httpd.conf	#修改监听的端口号
	/DocumentRoot
	DocumentRoot /var/www/myweb
echo abc > /var/www/myweb/index.html
systemctl restart httpd	#重启服务

#客户端测试
curl http://192.168.4.7	#成功
```

#### 修改http服务的默认端口号

```shell
vim /etc/httpd/conf/httpd.conf
	/Listen
	Listen 8080
netstate -anptu | grep httpd	#查看httpd服务的监听端口

#客户端测试
curl http://192.168.4.7	#失败
curl http://192.168.4.7:8080	#成功
```


#### 为浏览器程序提供URL网址

 `协议名://服务器地址[:端口号]/目录/文件名`

```shell
elinks -dump http://server0.example.com/
firefox http://server0.example.com/
```


### 改变网页文件存放路径

> 网络路径：浏览器中输入的路径（192.168.4.7/abc）
>
> 实际路径：服务器上网页文件存放的路径（/var/www/myweb /abc/index.html）

```shell
#服务端配置
mkdir/webapp
vim /etc/httpd/conf/httpd.conf
	DocumentRoot /webapp
echo woshiapp > /webapp/index.html
systemctl restart httpd

#客户端测试
curl http://192.168.4.7	#出现测试页面

#服务端配置
vim /etc/httpd/conf/httpd.conf
    <Directory "/webapp">	#新添加
        Require all granted	#对webapp目录设置为允许任何人访问
    <Directory>
systemctl restart httpd

#客户端测试
curl http://192.168.4.7	#出现woshiapp页面
```

### 配置文件说明
`/etc/httpd/conf/httpd.conf`	#主配置文件
`/etc/httpd/conf.d/*.conf`	#调用配置文件


### 域名解析（一台服务器使用两个域名，虚拟主机）
#### 为每个虚拟站点添加配置

```shell
vim /etc/httpd/conf.d/nsd01.conf
	<VirtualHost IP地址:端口>
		ServerName 此站点的DNS名称(www.qq.com)
		DocumentRoot 此站点的网页根目录(/var/www/qq)
	</VirtualHost>
```

#### 配置页面

服务端操作

```shell
setenforce 0
systemctl stop firewalld.services	#关闭防火墙

vim /etc/httpd/conf.d/nsd01.conf
    <VirtualHost *:80>
    	ServerName www.qq.com
    	DocumentRoot /var/www/qq
    </VirtualHost>
    <VirtualHost *:80>
    	ServerName www.baidu.com
    	DocumentRoot /var/www/baidu
    </VirtualHost>

mkdir /var/www/qq /var/www/baidu

echo "qq" > /var/www/qq/index.html
echo "baidu" > /var/www/baidu/index.html

systemctl restart httpd
```

客户端操作

```shell
vim /etc/hosts
    192.168.4.7 www.qq.com www.baidu.com

curl www.qq.com	#结果显示qq
curl www.baidu.com	#结果显示baidu
```


### 虚拟主机对web站点的影响

> 一旦启用虚拟主机之后，外部的DocumentRoot、ServerName都会被忽略
>
> 第一个虚拟站点被视为默认站点，若客户机请求的URL不属于任何已有站点，则有第一个站点响应
>
> 当独立web服务器升级为虚拟主机服务器之后，需要为原web站点建立一个虚拟站点


## NFS共享概述
Network File System，网络文件系统

> 用途：为客户机提供共享使用的文件夹
>
> 协议：NFS（TCP/UDP 2049）、RPC(TCP/UDP 111)
>
> 所需软件包：nfs-utils
>
> 系统服务：nfs-server


### exports（/etc/exports）配置文件解析

> 文件夹路径  客户端地址
>
> /test 192.168.4.0(ro)



### 实现NFS共享

服务端
```shell
rpm -q nfs-utils
yum -y install nfs-utils
mkdir /test
echo abc > /test/1.txt
vim /etc/exports
	/test 192.168.4.0(ro)

systemctl restart nfs-server
systemctl enable nfs-server
systemctl stop firewall
```

客户端

```shell
rpm -q nfs-utils
yum -y install nfs-utils
showmount -e 192.168.4.7
mkdir /abc
mount 192.168.4.7:/test /abc
df -h
ls /abc
```


### 实现开机自动挂载

> _netdev：声明网络设备，系统在网络服务配置完成后，再挂载本设备

```shell
vim /etc/fstab
192.168.4.7:/test /abc nfs defaults,_netdev 0 0
umount /abc
mount -a
df -h
```



## autofs触发挂载

由autofs提供的“按需访问”机制

> 只要访问挂载点，就会触发响应，自动挂载指定设备
>
> 闲置超过时限（默认5分钟）后，会自动卸载

```shell
yum -y install autofs
systemctl restart autofs
ls /
```

### autofs配置解析

> 主配置文件 /etc/auto.master
>
> `监控点目录` `/misc` `挂载配置文件的路径`


> 挂载配置文件，如 /etc/auto.misc
>
> `触发点子目录` `挂载参数` `:设备名`
>
> grep -v '^#' /etc/auto.misc
>
> `/misc /etc/auto.misc	#/misc为存放触发点的父文件夹`
>
> `cd -fstype=iso9660,ro,nosuid,nodev :/dev/cdrom`	#cd为autofs自动建立/移除的挂载点目录名


客户端

```shell
yum -y install autofs
systemctl restart autofs
ls /	#会出现misc的目录
ls /misc/
ls -A /misc
cd /misc/aa	#失败
cd /misc/bb	#失败
cd /misc/cd	#成功
pwd
ls
df -ah
vim /etc/auto.master	#查看即可，不作任何修改
vim /etc/auto.misc	#查看即可，不作任何修改
fdisk /dev/sdb	#划分一个3G的主分区
lsblk
mkfs.xfs /dev/sdb1
blkid /dev/sdb1
ls /misc/mydev
vim /etc/suto.misc	#当触发/misc/mydev时，实现将/dev/sdb1自动挂载
	mydev -fstype=xfs :/dev/sdb1

ls /misc/mydev
df -ah
```

客户端

```shell
vim /etc/auto.master
    /haha /etc/xoxo.conf

vim /etc/xixi.conf
    abc -fstype=cfs "/dev/sdb1

systemctl restart autofs
ls /haha/abc
df -ah
```


```shell
vim /etc/auto.misc
autonfs -fstype=nfs 192.168.4.7:/public
ls /misc/autonfs
df -ah
```



### 配置DNS服务器

```shell
#服务器配置
yum -y install bind bind-chroot.x86_64
rpm -q bind bind-chroot

vim /etc/named.conf
    options {
            directory       "/var/named";
    };
    
    zone "tedu.cn" IN {
            type master;
            file "tedu.cn.zone";
    };

named-checkconf /etc/named.conf	#检查主配置文件是否存在语法问题

cp -p /var/named/named.localhost /var/named/tedu.cn.zone
vim /var/named/tedu.cn.zone
	$TTL 1D
	@       IN SOA  @ rname.invalid. (
	                                        0       ; serial
	                                        1D      ; refresh
	                                        1H      ; retry
	                                        1W      ; expire
	                                        3H )    ; minimum
	
	tedu.cn.        NS      svr7.tedu.cn.
	www.tedu.cn.    A       192.168.4.100

named-checkzone tedu.cn /var/named/tedu.cn.zone	#检查地址库文件是否存在语法问题
systemctl restart named	#重启服务

systemctl stop firewalld.service    #关闭防火墙
setenforce 0


# 客户端验证
echo "nameserver 192.168.4.7" > /etc/resolv.conf
yum -y install bind-utils
nslookup www.tedu.cn
```


#### 构建多区域的DNS（多区域DNS服务）
服务端：
```shell
#修改主配置文件，在下面新添加
vim /etc/named.conf
    options {
            directory       "/var/named";
    };
    #指定这台机器要解析的域名
    zone "tedu.cn" IN {
            type master;
            file "tedu.cn.zone";
    };
    zone "baidu.com" IN {
            type master;
            file "baidu.com.zone";
    };
    
cp -p /var/named/named.localhost /var/named/baidu.com.zone
cp -p /var/named/named.localhost /var/named/tedu.cn.zone
vim /var/named/baidu.com.zone
	$TTL 1D
	@       IN SOA  @ rname.invalid. (
	                                        0       ; serial
	                                        1D      ; refresh
	                                        1H      ; retry
	                                        1W      ; expire
	                                        3H )    ; minimum
	
	baidu.com.        NS      svr7
	svr7   A       192.168.4.7
	www    A       10.20.30.40

vim /var/named/tedu.cn.zone
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum
	tedu.cn.	NS	www.tedu.cn.
	www	A	192.168.4.7
	svr7	A	0.0.0.0

systemctl restart named	#重启服务
```

客户端操作：
```shell
yum -y install bind-utils
nslookup svr7.tedu.cn
nslookup www.baidu.com
```

#### 特殊的解析记录
基于DNS的站点负载均衡
一个域名 --> 多个不同IP地址

##### 基于解析记录的轮询（负载均衡，缓解网站服务器的压力）

服务器：
```shell
vim /var/named/baidu.com.zone
	baidu.com	NS	svr7
	svr7	A	192.168.4.7
	www	A	192.168.4.50
	www	A	192.168.4.60
	www	A	192.168.4.70
	www	A	192.168.4.80
	www	A	192.168.4.90

systemctl restart named
```


客户端：
```shell
ping www.baidu.com
ping www.baidu.com
```


##### 泛域名解析
解决用户输入错误域名时的解析结果

```shell
#服务端
vim /var/named/baidu.com.zone
	* A 10.20.30.40

systemctl restart named

#客户端测试
nslookup wwww.baidu.com
```

##### 无规律的泛域名解析（无前置域名访问）
服务端：
```shell
vim /var/named/baidu.com.zone
    ···
    baidu.com. A 50.60.70.80

systemctl restart named
```

客户端：
```shell
nslookup baidu.com
```

##### 使用内置函数生成有规律的泛域名解析

> `$GENERATE 1-100 pc$ A 192.168.10.$`

```shell
vim /var/named/baidu.com.zone
	$GENERATE 1-100 pc$ A 192.168.10.$
	#$GENERATE 要生成的整数范围 pc$ A 192.168.10.$

system restart named    #重启服务

nslookup pc1.baidu.com    #测试结果
nslookup pc2.baidu.com
nslookup pc100.baidu.com
```

##### 使用别名解析（CNAME）

```shell
vim /var/named/baidu.com.zone
	···
	tts CNAME ftp
	#别名 CNAME 要解析的域名

systemctl restart named	#重启服务
nslookup tts.baidu.com	#测试结果
```

## 主/从DNS服务器

### 主域名服务器

特定DNS区域的官方服务器，具有唯一性

负责维护该区域内所有的“域名 <--> IP地址”记录

### 从域名服务器

也称为`辅助域名服务器`，可以没有

其维护的“域名 <--> IP地址”记录取决于主域名服务器

### 主/从DNS应用场景
案例环境
主DNS服务器的IP地址为 192.168.4.7/24

从DNS服务器的IP地址为192.168.4.207/24

其中任何一台都能提供对tedu.cn域的主机查询，返回相同的解析结果


#### 基本配置步骤
以区域tedu.cn为例，正常搭建好DNS服务

主服务器配置：

1. 装bind、bind-chroot软件包

2. 建立主配置文件

3. 建立区域数据文件

4. 启动named服务

5. 测试主DNS的域名解析

```shell
#主服务器配置
vim /etc/named.conf
	options {
                directory 	"/var/named";
		allow-transfer { 192.168.4.207; };
		#allow-transfer  { 从服务器的IP地址; };
	};
        zone "tedu.cn." IN {
		type master;
		file "tedu.cn.zone";
	};

cp -p /var/named/named.localhost /var/named/tedu.cn.zone
vim /var/named/tedu.cn.zone
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial    #版本号（10位数字组成，年月日修改次数 2020010101，做数据同步使用，用于在主服务器修改地址后，同步数值只可增加不可减小）
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum    #无效记录缓存时间

	tedu.cn NS pc207
	pc207 A 192.168.4.207
	#从服务器名称（NS记录必须写在A解析记录上）

systemctl restart named	#重启服务
systemctl stop firewalld.service    #关闭防火墙
setenforce 0
```

从服务器配置：

1. 装bind、bind-chroot软件包

2. 建立主配置文件

3. 启动named服务

4. 测试主DNS的域名解析

```shell
#从服务器配置
vim /etc/named.conf
    options {
        directory	"/var/named";
    };
    
    zone "tedu.cn" IN {
      	type slave;
    	file "/var/named/slaves/tedu.cn.slave";
        masters { 192.168.4.7; };
    };

systemctl restart named	#重启服务
```

客户端测试

```shell
#客户端测试
nslookup www.tedu.cn 192.168.4.7
nslookup www.tedu.cn 192.168.4.207
vim /etc/resolv.conf
    nameserver 192.168.4.7
    nameserver 192.168.4.207

nslookup www.tedu.cn    #会首先解析到主服务器
```

## 基础邮件服务
电子邮件通信


电子邮件服务器的基本功能

> 为用户提供电子邮箱存储空间（用户名@邮件域名）
>
> 处理用户发出的邮件 -- 传递给收件服务器
>
> 处理用户收到的邮件 -- 投递到邮箱 


### 配置邮件服务器的DNS

服务器端（svr7）构建DNS服务器

```shell
yum -y install bind bind-chroot
vim /etc/named.conf 
	options {
		directory 	"/var/named";
	};
	zone "example.com." IN {
		type master;
		file "example.com.zone";
	};

cp -p /var/named/named/named.localhost /var/named/example.com.zone
vim /var/named/example.com.zone
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum
	example.com.	NS	svr7
	example.com.	MX	10 mail    #MX邮件交互记录，10为第几台邮件服务器，数字越小优先级越高；mail：邮件服务器
	svr7	A	192.168.4.7
	mail	A	192.168.4.207

systemctl restart named
```

客户端（pc207）主机验证邮件交换记录

```shell
echo "nameserver 192.168.4.7" > /etc/resolv.conf	
yum -y install bind-utils
host -t MX example.com	#查看在example.com域中邮件服务器是谁
host mail.example.com	#查看邮件服务器解析
```


### 构建邮件服务器

#### 邮件服务搭建

```shell
rpm -q postfix
vim /etc/postfix/main.cf
	#99行 - 去除注释
	myorigin = example.com	#默认补全的域名后缀

	#116行
	inet_interfaces = all	#修改默认监听端口为所有网卡都提供邮件功能

	#164 行
	mydestination = example.com	#判断为本域邮件的依据

systemctl restart postfix	#重启服务

#测试
useradd fajianren	#发件用户
useradd shoujianren	#收件用户
yum -y install mailx	#安装邮件收发包
```

#### 交互式mail命令

语法格式：

> mail -s '邮件标题' -r 发件人 收件人
>
> 邮件内容
>
> .	#结束邮件

```shell
mail -s "test01" -r fajianren shoujianren
	邮件内容
	.	#结束邮件

mail -u xln	#查看邮件
	1
	q
```

#### 非交互式mail命令

语法格式：

> echo "邮件内容" | mail -s '邮件标题' -r 发件人 收件人

```shell
echo abc | mail -s 'mail title' -r fajianren shoujianren	#使用非交互式命令发送邮件
mail -u shoujianren	#检查邮件
```


## 分离解析概述

### 分离解析：

当收到客户机的DNS查询请求的时候


> 能够区分客户机的来源地址
>
> 为不同类别的客户机提供不向的解析结果（IP地址）



典型适用场景：

> 访问压力大的网站，购买CDN提供的内容分发服务
>
> 在全国各地/不同网终内部署大量镜像服务节点
>
> 针对不同的客户机就近提供服务器


### BIND的view视图

匹配原则：由上到下

> 根据源地址集合将客户机分类
>
> 不同客户机获得不同结果(待遇有差别)

```shell
view "联通" {
	match-clients { 来源地址1; ...; }:
	zone "12306.cn" IN 
		...地址库1;
	};  };
view "铁通" {
	match-clients { 来源地址2; ...; };
	zone "12306.cn" IN {
		...地址库2;
	}; };
```


### 分离解析实例

服务端（svr）7操作:

```shell
vim /etc/named.conf
	options {
		directory /var/named";
	}；
	view "VIP" {
		match-clients { 192.168,4.207; };
		zone "tedu.en" IN {
			type master
			file "tedu.cn.zone";
		};
	};
	view "other" {
		match-clients { any; };
		zone "tedu.cn" IN {
			type master;
			file "tedu.cn.other;
		};
	};

cp -p /var/named/named.localhost /var/named/tedu.cn.zone
vim /var/named/tedu.cn.zone
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum

	tedu.cn.	NS	svr7
	svr7	A	192.168.4.7
	www	A	192.168.4.100

cp -p /var/named/tedu.cn.zone /var/named/tedu.cn.other
vim /var/named/tedu.cn.other
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum

	tedu.cn.	NS	svr7
	svr7	A	192.168.4.7
	www	A	1.2.3.4

systemcti restart named
```

分别用pc207和虚拟机A验证

```shell
nslookup www.tedu.cn
```


## 缓存DNS概述
作用：缓存解析记录，加快解析速度


缓存DNS的适用场景


主要适用环境：


> 互联网出口带宽较低的企业局域网络
>
> ISP服务商的公共DNS服务器


### 构建缓存服务器

客户端（pc207）
```shell
yum -y install bind bind-chroot
vim /etc/namd.conf
	options {
		directory"/var/named";
		forwarders	{ 192.168.4.7 };	#转发地址
	};

systemctl restart named
```

客户端验证（A）
```shell
nalookup www.tedu.cn 192.168.4.207
```



















## 远程管理ssh

### SSH协议（Secure Shell）

> 为客户机提供安全的 Shell 环境
>
> 默认端口：**TCP22**


### OpenSSH 服务

> 服务名称：sshd
>
> 主程序：/use/sbin/sshd、/usr/bin/ssh
>
> 配置主件：/etc/ssh/sshd_config
>
> 	/etc/ssh/ssh_config

### SSH的基本使用

```shell
ssh root@要远程主机的ip地址	#远程指定的主机

ssh root@要使用图形界面远程主机的ip地址	#使用图形界面远程指定的主机
firefox	#测试图形界面状态下
```


### 使用scp远程复制工具
#### 安全复制工具scp

```shell
scp -r 用户名@服务器:远程路径 本地路径	#将指定主机上的文件下载到本地
scp -r 本地路径 用户名@服务器:远程路径	#将本地的文件上上传至指定主机
```

```shell
scp -r root@192.168.4.207:/boot /opt/	#将远程主机.207的目录boot复制到本地opt目录下
scp -r /boot root@192.168.4.207:/opt/	#将本机的boot目录复制到远程主机.207主机的opt目录下
```

### 实现ssh无密码验证
部署公钥与私钥
生成公钥与私钥

```shell
ssh-keygen
（使用默认ssh路径）
（实现ssh无密码验证，不需要设置密码）
（确认密码）
ls /root/.ssh
cat /root/.ssh/known_hosts

ssh-copy-id root@要传输公钥目标主机（无密码登陆）的ip地址
ssh root@无密码登陆目标主机的ip地址
```

传递公钥到对方主机




## 练习 4.25

### 案例：使用ssh客户端
准备虚拟机A和虚拟机B，完成以下操作
1. 从主机A(192.168.4.7)上以root身份登入主机B(192.168.4.207)

```shell
ssh root@192.168.4.207
```

2. 在主机B上创建用户student，设置密码为redhat

```shell
useradd student
echo redhat | passwd --stdin student
```

3. 从主机A上以用户student登入主机B

```shell
ssh student@192.168.4.207
```

### 案例：使用scp远程复制工具
1. 在主机A上使用scp下载文档
a. 将主机B上的/root/anaconda-ks.cfg文件复制到/opt下

```shell
scp -r root@192.168.4.207:/root/anaconda-ks.cfg /opt/
ls /opt/
```

b. 将主机B上的/home目录复制到本地的/opt下

```shell
scp -r root@192.168.4.207:/home /opt
ls /home
```

2. 在主机A上使用scp上传文档
a. 确保主机B上有本地用户lisi

```shell
id lisi
```

b. 将本地的/root/anaconda-ks.cfg文件复制到主机B上用户lisi的家目录下，以用户lisi的密码验证

```shell
scp -r /root/anaconda-ks.cfg lisi@192.168.4.207:/home/lisi
su lisi
ls
```

## 4.26 练习
### 案例
1. 利用ip命令查看ip地址

    ```shell
    ip address show
    ```

2. 利用ip命令为本机第一张网卡添加ip地址192.168.100.10/24

    ```shell
    ip address add 192.168.100.10/24 dev ens33
    ```

3. 利用ip命令添加路由，去往200.0.0.0/24下一跳为192.168.100.10

    ```shell
    ip route add 200.0.0.0/24 via 192.168.100.10 dev ens33
    ```

4. 安装vsftpd软件包

    ```shell
    yum -y install vsftpd
    ```

5. 启动vsftpd服务（systemctl restart vsftpd）

    ```shell
    systemctl restart vsftpd
    ```
    
6. 查看vsftpd服务监听的端口号

    ```shell
    netstat -anptu | grep vsftpd
    ```


## 4.27 练习
### 实验环境准备
虚拟机A
1. 主机名配置为A.tedu.cn

    ```shell
    hostname A.tedu.cn
    echo A.tedu.cn > /etc/hostname
    ```

2. IP地址配置为192.168.4.10/24

    ```shell
    nmcli connection modify ens33 ipv4.method manual ipv4.addresses 192.168.4.10/24 connection.autoconnect yes
    nmcli connection up ens33 
    ```

3. 用真机Xshell远程到虚拟机A

    ```shell
    ssh root@192.168.4.10
    ```

4. 将tools.tar.gz包传输到虚拟机A

    ```shell
    tar xf /root/tools.tar.gz /
    ```

5. 将tools.tar.gz解压到/tools文件夹下

    ```shell
    mkdir /tools/
    tar xf /root/tools.tar.gz /tools/
    ```

6. 源码编译安装inotify-tools-3.13.tar.gz，安装位置为/opt/abc

    ```shell
    ./configure --prefix=/opt/abc
    vim /etc/yum.repos.d/mnt.repo
        [mnt]
        name=Centos7.5
        baseurl=file:///dvd
        enabled=1
        gpgcheck=0
        [mymnt]
        name=Centos7.5
        baseurl=file:///tools/tools/other
        enabled=1
        gpgcheck=0
    
    rm -rf /etc/yum.repos.d/C*
    yum clean all
    yum repolist
    
    createrepo /tools/tools/other/
    yum -y install gcc
    yum -y install make
    
    rpm -q gcc make	#检查安装情况
    
    tar -xf /tools/tools/inotify-tools-3.13.tar.gz -C /opt
    
    cd /opt/inotify-tools-3.13/
    
    make
    make install
    
    ls /opt/abc/
    ```
## 4.28 练习
### 案例

1. 在svr7安装web服务和ftp服务

    ```shell
    #前提：安装yum源
    yum -y install httpd
    systemctl start httpd
    
    yum -y install vsftpd
    systemctl start vsftpd
    ```

2. 修改防火墙默认区域，在pc207上验证

    ```shell
    firewall-cmd --set-default-zone=trusted
    
    curl http://192.168.4.7	#使用另一台主机进行验证
    curl ftp://192.168.4.7
    ```

## 4.29 练习
### 将虚拟机A，svr7，pc207开机，网络模式选为vmnet1
1. 将虚拟机A主机名设置为A.tedu.cn

    ```shell
    hostname A.tedu.cn
    echo A.tedu.cn > /etc/hostname
    ```

2. 将虚拟机A IP地址设置为192.168.4.10
   
    ```shell
    nmcli connection modify ens33 ipv4.method manual ipv4.addresses 192.168.4.10/24 connection.autoconnect yes 
    nmcli connection up ens33 
    ```

3. 在虚拟机A上构建web服务和ftp服务

    ```shell
    mount /dev/cdrom /mnt
    
    vim /etc/yum.repos.d/a.repo
        [mnt]
        name=Centos
        baseurl=file:///mnt
        gpgcheck=0
        enabled=1
        
    rm -rf /etc/yum.repos.d/C*
    yum clean all
    yum repolist 
    
    yum repolist 
    yum -y install httpd
    yum -y install vsftpd
    systemctl start vsftpd
    systemctl start httpd
    
    curl http://192.168.4.10
    curl ftp://192.168.4.10
    ```

4. 用真机xshell远程到虚拟机A，svr7，pc207

    ```shell
    ssh root@192.168.4.10
    ```

5. 关闭虚拟机A，svr7，pc207的selinux

    ```shell
    vim /etc/selinux/config 
        SELINUX=disabled
    ```

### 案例1：新建一台虚拟机，要求如下：
1. 硬盘80G，内存2G
2. 采取自动分区规划
3. 软件选择“最小安装”

### 案例2（重复）(最小化装机）： 配置网络参数，要求如下：
1. 永久设置主机名为 A.tedu.cn

    ```shell
    echo A.tedu.cn > /etc/hostname
    hostname A.tedu.cn
    
    hostname
    ```

2. 永久配置静态IP地址为192.168.4.20/24

    ```shell
    nmcli connection modify ens33 ipv4.addresses 192.168.4.20/24 connection.autoconnect yes

    #安装yum源
    mount /dev/cdrom /mnt/	#先连接光盘
    echo "/dev/cdrom /mnt iso9660 defaults 0 0" >> /etc/fstab
    
    echo "[mnt]
    name=Centos7.5
    baseurl=file:///mnt
    enable=1
    gpgcheck=0" > /etc/yum.repos.d/mnt.repo
    
    rm -rf /etc/yum.repos.d/CentOS-*
    yum clean all
    yum repolist
    
    yum -y install vim-enhanced	#安装vim包
    yum -y install net-tools	#安装ifconfig支持包
    yum -y install bash-completion	#安装Tab键支持包
    reboot	#重启以生效
    #调整网络适配器，开机
    
    nmcli connection modify ens33 ipv4.addresses 192.168.4.20/24 connection.autoconnect yes
    nmcli connection up ens33
    ```

3. 用真机XShell远程到虚拟机B

    ```shell
    ssh root@192.168.4.20
    ```

### 案例3：练习克隆
1. 将A机器进行克隆
2. 克隆后的机器配置要求如下：
   a. 永久设置主机名为 B.tedu.cn

    ```shell
    echo B.tedu.cn > /etc/hostname
    hostname B.tedu.cn
    
    hostname
    ```

b. 永久配置静态IP地址为192.168.4.30/24

    ```shell
    nmcli connection modify ens33 ipv4.addresses 192.168.4.30/24 connection.autoconnect yes
    nmcli connection up ens33
    ```

### 案例4（重复）：复制，拷贝，移动要求如下：
1. 新建目录结构/student/test/nsd

    ```shell
    mkdir -p /student/test/nsd
    ```

2. 在目录/student/test/nsd创建文件testa.txt并写入内容 NSD  Student


    ```shell
    echo "NSD  Student" > /student/test/nsd/testa.txt
    ```

3. 将/student/test/nsd/testa.txt文件复制到/root目录下，同时改名为 tedu.txt

    ```shell
    cp /student/test/nsd/testa.txt /root/tedu.txt
    ```

4. 将/etc/passwd 、/etc/resolv.conf、/etc/hosts 同时拷贝到/student/test/nsd目录下

    ```shell
    cp /etc/passwd /etc/resolv.conf /etc/hosts /student/test/nsd
    ```

5. 将文件 student/test/nsd 重改名为 hs.txt

    ```shell
    mv student/test/nsd student/test/hs.txt
    ```

### 案例5（重复）:查找并处理文件
1. 创建目录/root/findfiles/

    ```shell
    mkdir /root/findfiles/
    ```

2. 利用find查找所有用户 lisi 拥有的必须是文件,把它们拷贝到 /root/findfiles/ 文件夹中

    ```shell
    useradd lisi
    mkdir /root/findfiles/
    find / -user lisi -a -type f -exec cp {} /root/findfiles/ \;
    ```

3. 利用find查找/boot目录下大于10M并且必须是文件，拷贝到/opt

    ```shell
    find /boot -size +10M -type f -exec cp {} /opt \;
    ```

4. 利用find查找/boot/ 目录下以 vm 开头且必须是文件，拷贝到/opt

    ```shell
    find /boot -name "vm*" -type f -exec cp {} /opt \;
    ```

5. 利用find查找/etc 目录下，以 tab 作为结尾的 必须是文件

    ```shell
    find /etc -name "*tab" -type f -exec cp {} /opt \;
    ```

### 案例6（重复）:查找并提取文件内容
1. 在文件 /usr/share/dict/words 中查找到所有包含字符串 seismic 的行,将输出信息,写入到/opt/nsd18.txt

    ```shell
    grep seismic /usr/share/dict/words > /opt/nsd18.txt
    ```

2. 查看内核版本，将显示结果重定向到/root/version.txt

    ```shell
    uname -r > /root/version.txt
    ```

3. 查看红帽系统版本，将显示结果追加到/root/version.txt

    ```shell
    cat /red hat-release > /root/version.txt
    ```

4. 查看主机名将显示结果追加到/root/version.txt

    ```shell
    hostname > /root/version.txt
    ```

5. 将/etc/fstab文件中以UUID开头的信息，写入到/root/fstab.txt

    ```shell
    grep ‘^UUID’ /etc/fstab > /root/fastab.txt
    ```

6. 提取/etc/passwd以bash结尾的行，将其信息写入/opt/pass.txt

    ```shell
    grep ‘bash$’ /etc/passwd  > /opt/pass.txt
    ```

7. 复制/etc/login.defs文件到当前目录下，改名为init.txt

    ```shell
    cp /etc/login.defs ./init.txt
    ```
    
8. 提取init.txt文件里的有效配置（去除以#号开头，去除空行），保存为init2.txt

    ```shell
    grep -v '^#' init.txt | grep -v '^$' > init2.txt
    ```

    

### 案例7（重复）: MBR分区模式规划分区
1. 添加一块80G的硬盘并规划分区：
2. 划分2个10G的主分区；1个12G的主分区;2个10G的逻辑分区。

    ```shell
    fdisk /dev/sdb
        n
        p
        1
        
        +10G
        
        n
        p
        2
        
        +10G
        n
        p
        3
        
        +10G
        n
        e
        
        
        n
        e
        
        +10G
        n
        e
        
        +10G
    ```
### 案例8（重复）:构建 LVM 存储
1. 利用/dev/sdb1和/dev/sdb2 新建一个名为 systemvg 的卷组 

    ```shell
    vgcreate systemvg /dev/sdb1 /dev/sdb2
    vgs
    ```

2. 在此卷组中创建一个名为 vo 的逻辑卷，大小为10G 

    ```shell
    lvcreate -L 10G -n vo systemvg
    ```

3. 将逻辑卷 vo 格式化为 xfs 文件系统 

    ```shell
    mkfs.xfs /dev/systemvg/vo 
    blkid /dev/systemvg/vo
    ```

4. 将逻辑卷 vo 挂载到 /vo 目录，并在此目录下建立一个测试文件 votest.txt，内容为“I AM KING.” 

    ```shell
    mkdir /vo
    mount /dev/systemvg/vo /vo
    echo "I AM KING" > /vo/votest.txt
    cat /vo/votest.txt
    ```

5. 实现逻辑卷vo开机自动挂载到/vo

    ```shell
    vim /etc/fstab
        /dev/systemvg/vo /vo xfs defaults 0 0
    umount /vo
    df -h
    mount -a
    df -h /vo
    ```




### 案例9（重复）:构建 LVM 存储(修改PE大小)
1. 新的逻辑卷命名为 database，其大小为50个PE的大小，属于 datastore 卷组 

    ```shell
    vgcreate database /dev/sdb3
    vgs
    lvcreate -l 50 -n database datastore
    ```

2. 使用 EXT4 文件系统对逻辑卷 database 格式化，此逻辑卷应该在开机时自动挂载到/nsd/vo

    ```shell
    mkfs.ext4 /dev/database/datastore
    vim /etc/fstab
        /dev/database/datastore /nsd/vo ext4 defaults 0 0
    
    mkdir -p /nsd/vo
    mount -a
    df -h
    ```


### 案例10（重复）:扩展逻辑卷
1. 将/dev/systemvg/vo逻辑卷的大小扩展到30G

    ```shell
    vgs
    lvs
    
    vgextend systemvg /dev/sdb5 /dev/sdb6
    vgs
    lvextend -L 30G /dev/systemvg/vo
    
    df -h
    xfs_growfs /dev/systemvg/vo
    df -h /vo
    ```



### 案例11（重复）：创建用户
1. 创建一个名为alex的用户，用户ID是 3456。密码是flectrag

    ```shell
    useradd -u 3456 alex
    grep alex /etc/passwd
    echo flectrag | passwd --stdin alex
    id alex
    ```

### 案例12（重复）：创建用户和组
1. 一个名为adminuser的组

    ```shell
    groupadd adminuser
    grep adminuser /etc/group
    ```

2. 一个名为natasha的用户，其属于adminuser，这个组是该用户的从属组

    ```shell
    useradd -G adminuser natasha
    grep natasha /etc/group
    ```

3. 一个名为harry的用户，属于adminuser，这个组是该用户的从属组

    ```shell
    useradd -G adminuser harry
    grep harryr /etc/group
    ```

4. 一个名为sarah的用户，其在系统中没有可交互的shell，并且不是adminuser组的成员用户

    ```shell
    useradd -s /sbin/nologin sarah
    grep sarah /etc/group
    ```

5. natasha、harry、和sarah的密码都要设置为flectrag

    ```shell
    echo flectrag | passwd --stdin natasha
    echo flectrag | passwd --stdin harry
    echo flectrag | passwd --stdin sarah
    ```

### 案例13（重复）：配置文件 /var/tmp/fstab 的权限
1.  拷贝文件/etc/fstab到/var/tmp/fstab，配置文件/var/tmp/fstab的权限：

    ```shell
    cp /etc/fstab /var/tmp/fstab
    ```

2. 文件/var/tmp/fstab的拥有者是root用户
3. 文件/var/tmp/fstab属于root组

    ```shell
    chown root:root /var/tmp/fstab
    ls -ld /var/tmp/fstab 
    ```

4. 文件/var/tmp/fstab对任何人都不可执行
   
    ```shell
    chmod -x /var/tmp/fstab
    ls -l /var/tmp/fstab
    ```

5. 用户natasha 能够对文件/var/tmp/fstab执行读和写操作

    ```shell
    setfacl -m u:natasha:rw /var/tmp/fstab
    setfacl /var/tmp/fstab
    ```
    
6. 用户harry 对文件/var/tmp/fstab既不能读，也不能写

    ```shell
    setfacl -m u:harry:- /var/tmp/fstab
    getfacl /var/tmp/fstab
    ```

7. 所有其他用户（当前的和将来的）能够对文件/var/tmp/fstab进行读操作

    ```shell
    ls -l /var/tmp/fstab
    ```


### 案例14（重复）：创建一个归档
1. 创建一个名为 /root/backup.tar.bz2 的归档文件，其中包含 /usr/local 目录中的内容，tar 归档必须使用 bzip2 进行压缩

    ```shell
    tar -jcf /root/backup.tar.bz2 /usr/local/
    ```

### 案例15（重复）：配置一个cron任务
1. 为用户 natasha 配置一个定时任务

    ```shell
    su natasha
    crontab -e
    
    crontab -e -u natasha
    ```

2. 每天在本地时间 14:23 执行
3. 需要完成的任务操作为 /bin/echo  hiya

    ```shell
    23 14 * * * /bin/echo hiya
    ```


### 案例16（重复）：设置别名
1. 为root用户永久设置别名为hn=‘hostname’

    ```shell
    su root
    vim ~/.bashrc
    	alias hn='hostname'
    ```

2. 为所有用户设置别名为 qstat='/bin/ps -Ao pid,tt,user,fname,rsz' 
   
    ```shell
    vim /etc/bashrc
    	qstat='/bin/ps -Ao pid,tt,user,fname,rsz'
    ```

### 案例17：实现虚拟机B的Web服务
1. 利用httpd软件搭建Web服务，页面显示内容为 I LIKE  LINUX.

    ```shell
    yum -y install httpd
    systemctl start httpd
    
    firefox http://192.168.4.10
    
    vim /var/www/html/index.html	#打开默认存放网页文件的路径进行编辑
    	I LIKE  LINUX.
    
    yum -y install elinks	#命令行浏览器
    
    elinks --dump http://192.168.4.10
    curl http://192.168.4.10	#命令行浏览器
    ```

### 案例18：实现虚拟机A的防火墙配置
1. 修改虚拟机A防火墙配置，明确拒绝所有客户端访问(默认区域修改为block)

    ```shell
    firewall-cmd --set-default-zone=block	#修改防火墙默认区域为block
    ```

2. 在虚拟机B上测试能否访问A的Web服务

    ```shell
    curl http://192.168.4.10	#不可以访问
    ```

3. 在虚拟机 B上测试能否 ping通 虚拟机A

    ```shell
    ping 192.168.4.10	#不可以访问
    ```


### 案例19：实现虚拟机A 的防火墙配置
1. 修改虚拟机A防火墙配置，将默认区域修改为trusted

    ```shell
    firewall-cmd --set-default-zone=trusted	#修改防火墙默认区域为trusted
    ```

2. 在虚拟机B上测试能否访问A的Web服务

    ```shell
    curl http://192.168.4.10	#可以访问
    ```

3. 在虚拟机B上测试能否 ping通 虚拟机 A

    ```shell
    ping 192.168.4.10	#可以访问
    ```


### 案例20：实现虚拟机A的防火墙配置
1. 修改虚拟机A防火墙配置，将默认区域修改为public

    ```shell
    firewall-cmd  --set-default-zone=public
    ```

2. 修改虚拟机A防火墙配置，在public区域中添加http协议,实现永久配置

    ```shell
    firewall-cmd --permanent --zone=public --add-service=http	#永久启动http服务
    firewall-cmd --reload    #重新加载配置文件
    firewall-cmd --permanent --zone=public --list-all    #查看区域策略
    
    netatat -anptu | grep :80    #过滤80端口
    systemcli status httpd    #查看http服务状态
    systemcli enable httpd    #设置http服务开机自启
    ```

3. 在虚拟机B上测试能否访问A 的Web服务

    ```shell
    curl ftp://192.168.4.10    #使用B主机检测，可以访问
    curl http://192.168.4.10    #使用B主机检测，可以访问
    ```

## 5.7 练习
服务端是svr7，客户端为pc207,完成以下案例

### 案例1：构建网络yum

利用ftp服务实现yum源提供服务
1. svr7构建vsftpd服务

    ```shell
    setenforce 0	#SELinux运行模式切换 0宽松 1强制
	/etc/selinux/config	#永久配置
    getenforce	#查看
    ststemctl stop firewall

    mount /dev/cdrom /mnt
    vim /etc/yum.repos.d/mnt.repo
    	[mnt]
    	name=Centos7.5
    	baseurl=file:///mnt
    	gpgcheck=0
    	enabled=1
    rm -rf /etc/yum.repos.d/C*
    yum clean all
    yum repolist
    
    yum -y install vsftpd
    systemctl start vsftpd
    systemctl status vsftpd #查看服务运行状态
    
    firewall-cmd --set-default-zone=trusted 
    
    curl ftp://192.168.4.7
    ```

2. 利用vsftpd服务提供如下内容：
   a. Centos7光盘内容

    ```shell
    mkdir /var/ftp/dvd
    mount /dev/cdrom /var/ftp/dvd
    ```

b. 自定义yum仓库内容

    ```shell
    vim /etc/yum.repos.d/dvd.repo
    	[dvd]
    	name=CentOS7.5
    	baseurl=ftp://192.168.4.7/dvd
    	enabled=1
    	gpgcheck=0
    
    yum clean all
    yum repolist
    ```

### 案例2：高级远程管理

1. 实现svr7远程管理pc207，无密码验证

    ```shell
    ssh root@192.168.4.207
    ssh-keygen
    ssh-copy-id root@192.168.4.207
    
    ssh root@192.168.4.207
    ```

2. 将svr7的/home目录拷贝到pc207的/opt目录下

    ```shell
    scp -r /home root@192.168.4.207:/opt/
    ls /opt
    ```

3. 将svr7的/etc/passwd文件拷贝到tom用户的家目录下，以用户tom的密码验证（用户tom密码为redhat）

    ```shell
    ssh root@192.168.4.207
    useradd tom
    echo 'redhat' | passwd --stdin tom
    scp -r /etc/passwd tom@192.168.4.207:/home/tom/
    ls /home/tom
    ```

### 案例练习
配置iSCSI服务端
1. 配置svr7提供iSCSI服务，磁盘名为iqn.2016-02.com.example:svr7，服务端口为3260，使用store作其后端卷，其大小为3GiB

    ```shell
    fdisk /dev/sdb
    	+3G
    partprobe /dev/sdb	#刷新分区
    lsblk
    
    yum -y install targetcli
    systemctl stop firewalld
    targetcli
    	ls
    	backstores/block create dev=/dev/sdb1 name=store
    	iscsi/ create iqn.2016-02.com.example:svr7
    	iscsi/iqn.2016-02.com.example:svr7/tpg1/luns create /backstores/block/store
    	iscsi/iqn.2016-02.com.example:svr7/tpg1/acls create iqn.2016-02.com.example:client
    	ls
    	exit
    systemctl restart target.service
    ```

配置iSCSI客户端

2. 配置pc207使其能连接上svr7提供的iqn.2016-02.com.example.svr7，iSCSI设备在系统启动期间自动挂载，块设备iSCSI上包含一个大小为2100MiB的分区，并格式化为ext4文件系统，此分区挂载在/mnt/data上，同时在系统启动的期间自动挂载

    ```shell
    #安装客户端软件
    yum -y install iscsi-initiator-utils
    rpm -q iscsi-initiator-utils
    
    #修改配置文件，指定客户端声称的名称
    vim  /etc/iscsi/initiatorname.iscsi
    	InitiatorName=iqn.2016-02.com.example.client
    
    #重启iscsi服务（主服务），使用共享存储
    systemctl restart iscsi	d
    iscsiadm --mode discoverydb --type sendtargets --portal 192.168.4.7 --discover	#利用命令发现服务端共享存储
    
    #iSCSI自动挂载
    systemctl restart iscsi	
    systemctl enable iscsi	
    
    #重起iscsid服务，仅仅是刷新客户端声称的名称
    systemctl restart iscsi
    
    #添加iSCSI 2100M分区
    fdisk /dev/sdb
    	+2100M
    partprobe /dev/sdb	#刷新分区
    lsblk
    
    #格式化为ext4文件系统类型?
    mkfs.ext4 /dev/sdb2
    
    #挂载到 /mnt/data
    umount /mnt
    mkdir /mnt/data
    mount /mnt/data
    mount /dev/sdb2 /mnt/data
    
    #系统启动自动挂载
    vim /etc/fstab
    	/dev/sdb2 /mnt/data ext4 defaults 0 0
    
    mount -a
    df -h
    ```

## 5.10
### 案例ISCSI练习

1. 为svr7添加一块10G硬盘
2. 在svr7操作，采用MBR分区模式利用/dev/sdb/划分一个主分区，大小为5G

    ```shell
    lsblk
    fdisk /dev/sdb
    n
    +5G
    w
    
    lsblk
    ```

3. 在svr7创建iscsi服务，磁盘名为iqn.2020-05.com.example:server，
   服务端口号为3260，使用nsd做后端卷，大小为5G

    ```shell
    yum -y install targetcli	#安装服务软件包 targetcli
    systemctl stop firewalld    #关闭防火墙
    targetcli	#运行 targetcli 命令进行配置
    	ls
    	
    	#创建后端存储
    	backstores/block create name=nsd dev=/dev/sdb1
    	ls
    	
    	#创建磁盘组target，使用IQN名称规范
    	iscsi/ create iqn.2020-05.com.example:server
    	
    	#创建lun关联
    	iscsi/iqn.2020-05.com.example:server/tpg1/luns/ create /backstores/block/nsd
    	
    	#设置访问控制（acl），设置客户端的名称
    	iscsi/iqn.2020-05.com.example:serve/tpg1/acls create iqn.2020-05.com.example:client
    
    	ls
    	exit
    systemctl restart target
    
    getenforce 0
    systemctl status firewalld.service
    ```



4. 在pc207上连接使用服务端提供的iqn.2020-05.com.example:server，
   并利用共享过来的磁盘划分一个主分区，大小为2G，格式化xfs文件系统类型，
   挂载到/data文件夹下

    ```shell
    #安装客户端软件
    yum -y install iscsi-initiator-utils
    rpm -q iscsi-initiator-utils
    
    #修改配置文件，指定客户端声称的名称
    vim  /etc/iscsi/initiatorname.iscsi
    	InitiatorName=iqn.2020-05.com.example:client
    
    #重起iscsid服务，刷新客户端声称的名称
    systemctl restart iscsid
    
    #利用命令发现服务端共享存储
    man iscsiadm	#查看iscsiadm帮助	/example按n向下匹配，按b向上匹配
    iscsiadm --mode discoverydb --type sendtargets --portal 192.168.4.7 --discover
    
    #重启iscsi服务（主服务），使用共享存储
    systemctl restart iscsi
    lsblk
    fdisk /dev/sdb
        n
        +2G
        
    mkfs.xfs /dev/sdb1
    mount /dev/sdb1 /data
    df -h
    ```


## 5.11 练习
### 案例：虚拟主机练习

1. 配置域名为www.tedu.cn，访问页面内容为I AM KING.
   
    ```shell
    yum -y install httpd
    vim /etc/httpd/conf.d/nsd01.conf
        <VirtualHost *:80>
        	ServerName www.tedu.cn
        	DocumentRoot /var/www/tedu
        </VirtualHost>
        <VirtualHost *:80>
        	ServerName www0.qq.com
        	DocumentRoot /var/www/qq
        </VirtualHost>
        <VirtualHost *:80>
        	ServerName www.baidu.com
        	DocumentRoot /var/www/baidu
        </VirtualHost>
    
    mkdir /var/www/qq /var/www/baidu /var/www/tedu
    
    echo I AM KING  > /var/www/tedu/index.html
    ```

2. 配置域名为www0.qq.com，访问页面内容为I GOOD STUDY.

    ```shell
       echo I GOOD STUDY  > /var/www/qq/index.html
    ```
    
3. 配置域名为www.baidu.com，访问页面内容为I AM girl.

    ```shell
    echo I AM girl  > /var/www/qq/index.html
    
    systemctl restart httpd
    ```



4. 用客户端pc207测试访问3个页面

    ```shell
    vim /etc/host
        192.168.4.7 www.baidu.com
        192.168.4.7 www.tedu.cn
        192.168.4.7 www0.qq.com
    
    curl www.baidu.com
    curl www.tedu.cn
    www0.qq.com
    ```




5. 书写页面内容为wo shi abc，用pc207测试页面内容（用IP地址访问）

    ```shell
    #svr7
    echo "wo shi abc" > /var/www/html/index.html
    
    vim /etc/httpd/conf.d/nsd01.conf
        <VirtualHost *:80>
                ServerName www.test.cn
                DocumentRoot /var/www/html
        </VirtualHost>
    
    systemctl restart httpd.service 
    
    
    #pc207
    vim /etc/hosts
        192.168.4.7 www.test.cn
    
    curl www.test.cn
    ```


### 案例15:为虚拟机A配置以下虚拟Web主机
实现三个网站的部署
1. 实现客户端访问server0.example.com网页内容为 大圣归来
2.  实现客户端访问www0.example.com网页内容为  大圣又归来
3.  实现客户端访问webapp0.example.com网页内容为 大圣累了

    ```shell
    setenforce 0
    systemctl stop firewalld.services	#关闭防火墙
    
    yum -y install httpd
    vim /etc/httpd/conf.d/nsd01.conf
        <VirtualHost *:80>
        	ServerName server0.example.com
        	DocumentRoot /var/www/server0
        </VirtualHost>
        <VirtualHost *:80>
        	ServerName www0.example.com
        	DocumentRoot /var/www/www0
        </VirtualHost>
        <VirtualHost *:80>
        	ServerName webapp0.example.com
        	DocumentRoot /var/www/webapp0
        </VirtualHost>
    
    mkdir /var/www/server0 /var/www/www0 /var/www/webapp0
    
    echo "大圣归来" > /var/www/server0/index.html
    echo "大圣又归来" > /var/www/www0/index.html
    echo "大圣累了" > /var/www/webapp0/index.html
    
    systemctl restart httpd
    
    #客户端测试
    echo 192.168.4.10 server0.example.com >> /etc/hosts
    echo 192.168.4.10 www0.example.com >> /etc/hosts
    echo 192.168.4.10 webapp0.example.com >> /etc/hosts
    
    curl server0.example.com
    curl www0.example.com
    curl webapp0.example.com
    ```

### 案例16：为虚拟机A配置web服务访问控制
1. 修改默认网页文件位置为/webapp1

    ```shell
    #服务端配置
    mkdir /webapp1
    vim /etc/httpd/conf/httpd.conf
    	DocumentRoot /webapp1
    ```


2. 实现访问/webapp1页面文件为index.html,内容为奔跑吧 骆驼

    ```shell
    #服务端配置
    echo "奔跑吧 骆驼" > /webapp1/index.html
    systemctl restart httpd
    
    #客户端测试
    curl http://192.168.4.7	#出现测试页面
    ```


### 案例17：发布iSCSI网络磁盘

配置 A提供 iSCSI 服务，要求如下：

1. 磁盘名为iqn.2020-06.com.example:server0
2. 服务端口为 3260
3. 使用 iscsi_store（后端存储的名称） 作其后端卷，其大小为 3GiB
4. 在A配置客户端ACL为iqn.2020-06.com.example:desktop0

    ```shell
    fdisk /dev/sdb
    	+3G
    partprobe /dev/sdb	#刷新分区
    lsblk
    
    yum -y install targetcli	#安装服务软件包 targetcli
    systemctl stop firewalld    #关闭防火墙
    targetcli	#运行 targetcli 命令进行配置
    	ls
    	
    	#创建后端存储
    	backstores/block create dev=/dev/sdb1 name=store
    	
    	#创建磁盘组target，使用IQN名称规范
    	iscsi/ create iqn.2020-06.com.example:server0
    	
    	#创建lun关联
    	iscsi/iqn.2020-06.com.example:server0/tpg1/luns create /backstores/block/store
    	
    	#设置访问控制（acl），设置客户端的名称
    	iscsi/iqn.2020-06.com.example:server0/tpg1/acls create iqn.2020-06.com.example:desktop0
    
    	ls
    	exit
    systemctl restart target.service
    ```


5. 配置虚拟机B使用虚拟机A提供 iSCSI 服务

    ```shell
    #安装客户端软件
    yum -y install iscsi-initiator-utils
    rpm -q iscsi-initiator-utils
    
    #修改配置文件，指定客户端声称的名称
    vim  /etc/iscsi/initiatorname.iscsi
    	InitiatorName=iqn.2020-06.com.example:desktop0
    
    #重起iscsid服务，仅仅是刷新客户端声称的名称
    systemctl restart iscsid
    
    #利用命令发现服务端共享存储（A的ip地址：192.168.4.7）
    man iscsiadm	#查看iscsiadm帮助	/example按n向下匹配，按b向上匹配
    iscsiadm --mode discoverydb --type sendtargets --portal 192.168.4.7 --discover
    
    #重启iscsi服务（主服务），使用共享存储
    systemctl restart iscsi
    lsblk
    ```
## 5.12 练习

在虚拟机svr7上配置NFS共享，完成如下操作
1. 以读写的方式访问目录/public，只能被192.168.4.0/24系统访问

    ```shell
    rpm -q nfs-utils
    yum -y install nfs-utils
    mkdir /public
    
    vim /etc/exports
    	/public 192.168.4.0/24(rw,no_root_squash)	#开放权限
    
    systemctl restart nfs-server
    systemctl enable nfs-server
    systemctl stop firewall
    ```

2. 在虚拟机pc207上访问NFS共享目录，挂载点为/nfs

    ```shell
    rpm -q nfs-utils
    yum -y install nfs-utils
    showmount -e 192.168.4.7
    
    mkdir /nfs
    mount 192.168.4.7:/public /nfs
    df -h
    ls /nfs
    ```


3. 实现开机自动挂载

> _netdev：声明网络设备，系统在网络服务配置完成后，再挂载本设备

```shell
vim /etc/fstab
    192.168.4.7:/test /abc nfs defaults,_netdev 0 0

mount /abc
mount -a
df -h
```



## 5.17 练习
案例：
提供以下正向解析记录的解析
1. svr7.tedu.cn --> 192.168.4.7

    pc207.tedu.cn --> 192.168.4.207

    www.tedu.cn --> 192.168.4.100

```shell
#服务器配置
systemctl stop firewalld.service 
setenforce 0

yum -y install bind bind-chroot.x86_64	#安装named包默认端口号53
rpm -q bind bind-chroot

vim /etc/named.conf
    options {
            directory       "/var/named";
    };
    
    #指定这台机器要解析的域名
    zone "tedu.cn" IN {
            type master;
            file "tedu.cn.zone";
    };

named-checkconf /etc/named.conf	#检查主配置文件是否存在语法问题

cp -p /var/named/named.localhost /var/named/tedu.cn.zone
#第二种方法：相对路径方式
cd /var/named/
cp -p named.localhost tedu.cn.zone

vim /var/named/tedu.cn.zone
	$TTL 1D
	@       IN SOA  @ rname.invalid. (
	                                        0       ; serial
	                                        1D      ; refresh
	                                        1H      ; retry
	                                        1W      ; expire
	                                        3H )    ; minimum
	
	tedu.cn.        NS      svr7.tedu.cn.
	svr7.tedu.cn.   A       192.168.4.7
	pc207.tedu.cn.  A       192.168.4.207
	www.tedu.cn.    A       192.168.4.100


named-checkzone tedu.cn /var/named/tedu.cn.zone	#检查地址库文件是否存在语法问题

systemctl restart services	#重启服务
```

2. 在客户机上验证查询结果

    ```shell
    #客户端测试
    yum -y install bind-utils
    echo "nameserver 192.168.4.7" > /etc/resolv.conf
    
    nslookup pc207.tedu.cn
    nslookup www.tedu.cn
    ```


## 5.18 练习
案例：构建多区域DNS
实现以下正向解析记录
1. 访问www.tedu.cn ---> 192.168.4.100
2. 访问www.baidu.com ---> 10.20.30.40
3. 访问ftp.baidu.com ---> 50.60.70.80

    ```shell
    #服务器配置
    systemctl stop firewalld.service 
    setenforce 0
    
    yum -y install bind bind-chroot.x86_64	#安装named包默认端口号53
    rpm -q bind bind-chroot
    
    vim /etc/named.conf	#指定这台机器要解析的域名
        options {
        	directory 	"/var/named";
        };
        
        zone "tedu.cn" IN {
        	type master;
        	file "tedu.cn.zone";
        };
        zone "baidu.com" IN {
        	type master;
        	file "baidu.com.zone";
        };
    
    named-checkconf /etc/named.conf	#检查主配置文件是否存在语法问题
    
    cp -p /var/named/named.localhost /var/named/tedu.cn.zone
    cp -p /var/named/named.localhost /var/named/baidu.com.zone
    
    vim /var/named/tedu.cn.zone
        $TTL 1D
        @	IN SOA	@ rname.invalid. (
        					0	; serial
        					1D	; refresh
        					1H	; retry
        					1W	; expire
        					3H )	; minimum
        tedu.cn.	NS	svr7
        svr7	A	192.168.4.7
        www	A	192.168.4.100
    
    vim /var/named/baidu.com.zone
        $TTL 1D
        @	IN SOA	@ rname.invalid. (
        					0	; serial
        					1D	; refresh
        					1H	; retry
        					1W	; expire
        					3H )	; minimum
        baidu.com.	NS	svr7
        svr7	A	192.168.4.7
        www	A	10.20.30.40
        ftp	A	50.60.70.80
    
    named-checkzone tedu.cn /var/named/tedu.cn.zone	#检查地址库文件是否存在语法问题
    named-checkzone baidu.com /var/named/baidu.com.zone
    
    systemctl restart services	#重启服务
    
    #客户端测试
    yum -y install bind-utils
    echo "nameserver 192.168.4.7" > /etc/resolv.conf
    
    nslookup www.tedu.cn
    nslookup www.baidu.com
    nslookup ftp.baidu.com
    ```


## 5.19 练习
案例：搭建主/从DNS服务器
1. 准备3台虚拟机，主机名及IP地址要求如下：


| 主机名        | IP地址        |
| ------------- | ------------- |
| svr7.tedu.cn  | 192.168.4.7   |
| pc207.tedu.cn | 192.168.4.207 |
| A.tedu.cn     | 192.168.4.10  |

虚拟机svr7
```shell
nmcli connection modify ens33 ipv4.method manual ipv4.addresses 192.168.4.7/24 connection.autoconnect yes 
nmcli connection up ens33 
ifconfig
hostname svr7.tedu.cn
echo svr7.tedu.cn > /etc/hostname
```

虚拟机pc207
```shell
nmcli connection modify ens33 ipv4.method manual ipv4.addresses 192.168.4.207/24 connection.autoconnect yes 
nmcli connection up ens33 
ifconfig
hostname pc207.tedu.cn
echo pc207.tedu.cn > /etc/hostname
```

虚拟机A
```shell
nmcli connection modify ens33 ipv4.method manual ipv4.addresses 192.168.4.10/24 connection.autoconnect yes 
nmcli connection up ens33 
ifconfig
hostname A.tedu.cn
echo A.tedu.cn > /etc/hostname
```


2. 构建主/从DNS服务


| 主DNS | svr7.tedu.cn  | 192.168.4.7   |
| ----- | ------------- | ------------- |
| 从DNS | pc207.tedu.cn | 192.168.4.207 |
| 提供  | www.tedu.cn   | 1.2.3.4       |

用虚拟机A测试。

虚拟机svr7
```shell
yum -y install bind bind-chroot.x86_64

vim /etc/named.conf
	options {
		directory 	"/var/named";
		allow-transfer     { 192.168.4.207; };
	};
	
	zone "tedu.cn." IN {
		type master;
		file "tedu.cn.zone";
	};

cp -p /var/named/named.localhost /var/named/tedu.cn.zone
vim /var/named/tedu.cn.zone
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum
	tedu.cn.	NS	svr7
	tedu.cn.	NS	pc207
	svr7	A	192.168.4.7
	pc207	A	192.168.4.207
	www	A	1.2.3.4

systemctl restart named	#重启服务
systemctl stop firewalld.service 
setenforce 0
```


虚拟机pc207
```shell
yum -y install bind bind-chroot.x86_64

vim /etc/named.conf 
	options {
		directory 	"/var/named";
	};
	zone "tedu.cn." IN {
		type slave;
		file "/var/named/slaves/tedu.cn.slave";
		masters { 192.168.4.7; };
	};

systemctl restart named
systemctl stop firewalld.service 
setenforce 0
```

虚拟机A
```shell
vim /etc/resolv.conf 
	nameserver 192.168.4.7
	nameserver 192.168.4.207

nslookup www.tedu.cn
```

## 5.20 练习
多区域DNS分离解析
1. 分类(配户端相同)相同：


192.168.4.207 --> www.tedu.cn --> 192.168.4.100


		www.qq.com


其他地址 --> www.tedu.cn --> 1.2.3.4


		www.qq.com



2. 分类(匹配客户端来源不相同)不相同：


客户端192.168.4.207 --> www.tedu.cn --> 192.168.4.100


客户端其他地址 --> www.tedu.cn --> 1.2.3.4


客户端192.168.4.10 --> www.qq.com -->192.168.10.100


客户端其他地址 --> www.qq.com --> 172.25.0.11



> 分析：
>
> 192.168.4.207 --> www.tedu.cn --> 192.168.4.100 --> 地址库tedu.cn.zone
>
> 192.168.4.207 --> www.qq.com --> 172.25.0.11 --> qq.com.other
>
> 
>
> 192.168.4.10 --> www.tedu.cn --> 1.2.3.4 --> tedu.cn.other
>
> 192.168.4.10 --> www.qq.com --> 192.168.10.100 --> qq.com.other
>
> 
>
> 其他地址 --> www.tedu.cn --> 1.2.3.4 --> tedu.cn.other
>
> 其他地址 --> www.qq.com --> 172.25.0.11 --> qq.com.zone

```shell
#服务端(svr7)
yum -y install bind bind-chroot
vim /etc/named.conf
	options {
		directory "/var/named";
	};
	view "nsd" {
		match-clients { 192.168.4.207; };
		zone "tedu.cn" IN {
			type master;
			file "tedu.cn.zone";	#解析结果为192.168.4.100
		};
		zone "qq.com" IN {
			type master;
			file "qq.com.zone";	#解析结果为172.25.0.11
		};
	 };
	view "vip" {
		match-clients { 192.168.4.10; };
		zone "tedu.cn" IN {
			type master;
			file "tedu.cn.other";	#解析结果为1.2.3.4
		};
		zone "qq.com" IN {
			type master;
			file "qq.com.other";	#解析结果为192.168.10.100
		};
	 };
	view "others" {
		match-clients { any; };
		zone "tedu.cn" IN {
			type master;
			file "tedu.cn.other";	#解析结果为1.2.3.4
		};
		zone "qq.com" IN {
			type master;
			file "qq.com.zone";	#解析结果为172.25.0.11
		};
	 };

cd /var/named/
cp -p named.localhost tedu.cn.zone
vim tedu.cn.zone
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum

	tedu.cn.	NS	svr7
	svr7	A	192.168.4.7
	www	A	1.2.3.4

cp -p tedu.cn.zone tedu.cn.other
vim tedu.cn.other
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum

	tedu.cn.	NS	svr7
	svr7	A	192.168.4.7
	www	A	192.168.4.100


cp -p tedu.cn.zone qq.com.zone
vim qq.com.zone
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum

	qq.com.	NS	svr7
	svr7	A	192.168.4.7
	www	A	172.25.0.11

cp -p qq.com.zone qq.com.other
vim qq.com.other
	$TTL 1D
	@	IN SOA	@ rname.invalid. (
						0	; serial
						1D	; refresh
						1H	; retry
						1W	; expire
						3H )	; minimum

	qq.com.	NS	svr7
	svr7	A	192.168.4.7
	www	A	192.168.10.100

systemctl restart named
```

客户机(pc207)
```shell
echo "nameserver 192.168.4.7" > /etc/resolv.conf
yum -y install bind-utils
nslookup www.qq.com
nslookup www.tedu.cn
```

客户机A
```shell
echo "nameserver 192.168.4.7" > /etc/resolv.conf
nslookup www.qq.com
nslookup www.tedu.cn
```

服务端(svr7)
```shell
echo "nameserver 192.168.4.7" > /etc/resolv.conf
yum -y install bind-utils
nslookup www.qq.com
nslookup www.tedu.cn
```


案例

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210601185635109.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDM0MDEyOQ==,size_16,color_FFFFFF,t_70)

web 服务器和 DNS 服务结合（web 服务器做需要开启基于域名的虚拟主机，DNS 需要使用分离解析技术）

| -            | 主机名        | ip地址        |
| ------------ | ------------- | ------------- |
| 虚拟机 A     | A.tedu.cn     | 192.168.4.10  |
| 虚拟机 B     | B.tedu.cn     | 192.168.4.20  |
| 虚拟机 C     | C.tedu.cn     | 192.168.4.208 |
| 虚拟机 svr7  | svr7.tedu.cn  | 192.168.4.7   |
| 虚拟机 pc207 | pc207.tedu.cn | 192.168.4.207 |

虚拟机 A 操作：

```shell
#1.安装软件包 httpd
yum -y install httpd

#2.建立修改调用配置文件
vim /etc/httpd/conf.d/nsd01.conf
    <VirtualHost *:80>
        ServerName www.qq.com
        DocumentRoot /var/www/qq
    </VirtualHost>
    <VirtualHost *:80>
        ServerName www.163.com
        DocumentRoot /var/www/163
    </VirtualHost>

mkdir /var/www/qq /var/www/163
echo '<h1> Web1 QQ' > /var/www/qq/index.html
echo '<h1> Web1 163' > /var/www/163/index.html

systemctl restart httpd
```

虚拟机 B 操作：

```shell
yum -y install httpd

#从虚拟机A拷贝nsd01配置文件
scp /etc/httpd/conf.d/nsd01.conf 192.168.4.20:/etc/httpd/conf.d/
mkdir /var/www/qq /var/www/163
echo '<h1>Web2 QQ' > /var/www/qq/index.html
echo '<h1>Web2 163' > /var/www/163/index.html

systemctl restart httpd
```

虚拟机 svr7 操作：

```shell
#1、修改主配置文件
vim /etc/named.conf
        ……
        view "vip" {
            match-clients { 192.168.4.207; };
            zone "163.com" IN {
                type master;
                file "163.com.zone";
            };
            zone "qq.com" IN {
                type master;
                file "qq.com.zone";
            };
        };
        view "other" {
            match-clients { any; };
            zone "163.com" IN {
                type master;
                file "163.com.other";
            };
            zone "qq.com" IN {
                type master;
                file "qq.com.other";
            };
        };

#2、建立地址库文件
cd /var/named/
cp -p qq.com.zone 163.com.zone
cp -p qq.com.zone 163.com.other

vim 163.com.zone
        …….
        163.com. NS svr7
        svr7 A 192.168.4.7
        www A 192.168.4.10

vim qq.com.zone
        …
        qq.com. NS svr7
        svr7 A 192.168.4.7
        www A 192.18.4.10

vim 163.com.other
        …
        163.com. NS svr7
        svr7 A 192.168.4.7
        www A 192.168.4.20

vim qq.com.other
        ……
        qq.com. NS svr7
        svr7 A 192.168.4.7
        www A 192.168.4.20

systemctl restart named
```

测试：指定 DNS 服务器地址
虚拟机pc207

```shell
echo nameserver 192.168.4.7 > /etc/resolv.conf
curl www.qq.com
curl www.163.com
```

虚拟机C
```shell
echo nameserver 192.168.4.7 > /etc/resolv.conf
curl www.qq.com
curl www.163.com
```

## 6.2 练习
### 案例19：普通NFS共享的实现
1. 只读的方式共享目录 /public，只允许192.168.4.0网段访问

    ```shell
    rpm -q nfs-utils
    yum -y install nfs-utils
    mkdir /public
    touch /public/p1.txt
    
    echo "/public *(ro)" >> /etc/exports
    ```

2. 可读写共享目录/protected，允许所有人访问

    ```shell
    mkdir /protected
    touch /protected/p2.txt
    echo "/protected 192.168.4.0/24(rw,no_root_squash)" >> /etc/exports
    
    systemctl restart nfs-server
    systemctl enable nfs-server
    systemctl stop firewall.service
    ```

3. 在虚拟机 B上访问NFS共享目录
   3.1. 将A 的 /public 挂到本地 /nfsmount

    ```shell
    #虚拟机B操作
    yum -y install nfs-utils
    showmount -e 192.168.4.10
    
    mkdir /nfsmount
    mount 192.168.4.10:/public /nfsmount
    df -h
    ls /nfsmount
    ```


4. 这些文件系统在系统启动时自动挂载
   4.1. 将/protected实现触发挂载到/abc/mynfs下

    ```sehll
    mkdir -p /abc/mynfs
    
    echo "192.168.4.10:/public /nfsmount nfs defaults,_netdev 0 0" >> /etc/fstab
    echo "192.168.4.10:/protected /abc/mynfs nfs defaults,_netdev 0 0" >> /etc/fstab
    
    umount /nfsmount
    mount -a
    df -h
    ```



### 案例20：iscsi磁盘共享

0. 配置 虚拟机A提供 iSCSI 服务，要求如下：
1. 磁盘名为iqn.2020-08.tedu.cn:server0
2. 服务端口为 3260
3. 使用 store（后端存储的名称） 作其后端卷，其大小为 3GiB
4. 配置客户端ACL为iqn.2020-08.tedu.cn:desktop0
5. 配置虚拟机B使用 虚拟机svr7提供 iSCSI 服务

```shell
partprobe /dev/sdc
lsblk
yum -y install targetcli
systemctl stop firewalld
targetcli
	ls
	backstores/block create dev=/dev/sdc1 name=store
	iscsi/ create iqn.2020-08.tedu.cn:server0
	iscsi/iqn.2020-08.tedu.cn:server0/tpg1/luns create /backstores/block/store
	iscsi/iqn.2020-08.tedu.cn:server0/tpg1/acls create iqn.2020-08.tedu.cn:desktop0
	ls
	exit
systemctl restart target.service
```

```shell
#虚拟机B
yum -y install iscsi-initiator-utils
rpm -q iscsi-initiator-utils

echo "InitiatorName=iqn.2020-08.tedu.cn:desktop0" > /etc/iscsi/initiatorname.iscsi

systemctl restart iscsid
iscsiadm --mode discoverydb --type sendtargets --portal 192.168.4.10 --discover

systemctl restart iscsi	
systemctl enable iscsi	

systemctl restart iscsi
	
lsblk
```


### 案例21：NTP时间同步
0. 在虚拟机A设置ntp时间同步
1. 设置时间服务器上层与0.centos.pool.ntp.org同步
2. 设置本地服务器层数为10
3. 允许192.168.4.0/24网络的主机同步时间
4. 客户端B验证时间是否同步

```shell
yum -y install chrony
rpm -qc chrony	#查看配置文件（.conf结尾的文件）

vim /etc/chrony.conf
	server 0.centos.pool.ntp.org iburst	#网络标准时间服务器（快速同步）
	allow 192.168.4.0/24	#允许同步时间的主机网络段
	local statum 10	#访问层数

systemctl restart chronyd	#重启时间同步服务

setenforce 0
systemctl stop firewalld	#关闭防火墙
```


```shell
#虚拟机B
vim /etc/chrony.conf
	server 192.168.4.10 iburst	#指定要同步时间的服务器（192.168.4.7）
systemctl restart chronyd	#重启时间同步服务
chronyc sources -v	#验证时间是否同步成功
```


### 案例22：利用FTP服务实现网络yum源
1. 虚拟机A构建ftp服务

    ```shell
    yum -y install vsftpd
    systemctl restart vsftpd
    ```


2. 利用ftp服务提供Centos7光盘内容，自定义yum仓库内容

    ```shell
    ls /var/ftp/
    mkdir /var/ftp/centos
    mount /dev/cdrom /var/ftp/centos/
    ls /var/ftp//centos/
    firefox ftp://192.168.4.10/centos
    
    #虚拟机软件-toos.tar.gz -> /root
    tar -xf tools.tar.gz
    ls tools/other/
    mkdir /var/ftp/other/
    cp tools/other/* /var/ftp/other/
    ls /var/ftp/other
    createrepo /var/ftp/other/
    ls /var/ftp/other
    ```

3. 利用虚拟机B进行测试，并安装软件包sl

    ```shell
    vim /etc/yum.repos.d/mnt.repo
    	[centos]
    	name=Centos7.5
    	baseurl=ftp://192.168.4.10/centos
    	gpgcheck=0
    	[myrpm]
    	name=myyum
    	baseurl=ftp://192.168.4.10/other
    	gpgcheck=0
    
    yum clean all
    yum repolist
    
    yum -y install sl
    sl
    ```

    











&&&&&&&&&&&&&&



### 最小化装机
2. 永久配置静态IP地址为192.168.4.20/24

    ```shell
    nmcli connection modify ens33 ipv4.addresses 192.168.4.20/24 connection.autoconnect yes

    ### xshell
    
    mount /dev/cdrom /mnt/
    
    echo "[mnt]
    name=Centos7.5
    baseurl=file:///mnt
    enabled=1
    gpgcheck=0" > /etc/yum.repos.d/mnt.repo
    
    rm -rf /etc/yum.repos.d/CentOS-*
    yum clean all
    yum repolist
    echo "/dev/cdrom /mnt iso9660 defaults 0 0" >> /etc/fstab
    
    yum -y install vim-enhanced
    yum -y install net-tools
    yum -y install bash-completion
    
    systemctl stop firewalld
    setenforce 0
    ```



##  ISCSI服务 虚拟磁盘技术

* svr7

```shell
### 添加磁盘
reboot
systemctl stop firewalld
setenforce 0
fdisk /dev/sdb
	n +5G
	p
	wq
partprobe /dev/sdb
lsblk
yum -y install targetcli
rpm -q targetcli
targetcli
ls
backstores/block create dev=/dev/sdb1 name=iscsi_store
iscsi/ create iqn.2021-05.com.example:server
iscsi/iqn.2021-05.com.example:server/tpg1/luns create /backstores/block/iscsi_store
iscsi/iqn.2021-05.com.example:server/tpg1/acls create iqn.2021-05.com.example:desktop
ls
exit
systemctl restart target.service
systemctl enable target.service
```



* pc207

```shell
yum -y install iscsi-initiator-utils
rpm -q iscsi-initiator-utils
echo "InitiatorName=iqn.2021-05.com.example:desktop" > /etc/iscsi/initiatorname.iscsi
systemctl restart iscsi	d
iscsiadm --mode discoverydb --type sendtargets --portal 192.168.4.7 --discover
```



* pc207

```shell
#iSCSI自动挂载,格式化为 xfs 文件系统,挂载在/data 上
systemctl restart iscsi	
systemctl enable iscsi
partprobe /dev/sdb
lsblk
fdisk /dev/sdb
	n
	+2100M
    p
	wq
partprobe /dev/sdb
lsblk

mkfs.xsf /dev/sdb1
mkdir /data
mount /dev/sdb1 /data
echo "/dev/sdb1 /data xfs defaults,_netdev 0 0":wq >> /etc/fstab
mount -a
df -h
```





案例五 普通NFS共享

* svr7
```shell
yum -y install nfs-utils
mkdir /public
mkdir /protected
echo "/public 192.168.4.0/24(ro)                              
/protected (rw)" > /etc/exports
systemctl restart nfs-server
systemctl enable nfs-server
```

* pc207
```shell
yum -y install nfs-utils
showmount -e 192.168.4.7
mkdir /nsd
mount 192.168.4.7:/public /nsd
df -h
ls /nsd
echo "192.168.4.7:/public /nsd nsd defaults,_netdev  0  0" >> /etc/fstab
mount -a
yum  -y install autofs
systemctl restart autofs
echo "autonfs -fstype=nfsmount 192.168.4.7:/protected" >> /etc/auto.misc
systemctl restart autofs
ls /misc
cd  /misc/autonfs  
df -ah
```

















































































# 数据库

### 常见软件

主流操作系统：Unix, Linux, Windows

| 软件名     | 开源 | 跨平台 | 厂商     |
| ---------- | ---- | ------ | -------- |
| Oracle     | 否   | 是     | 甲骨文   |
| MysQL      | 是   | 是     | 甲骨文   |
| SQL Server | 否   | 否     | 微软     |
| DB2        | 否   | 是     | IBM      |
| Redis      | 是   | 是     | 开源软件 |
| Memcached  | 是   | 是     | 开源软件 |
| MongoDB    | 是   | 是     | 开源软件 |


### 专业术语
* DB (DataBase)
- 数据库
- 依照某种数据模型进行组织并存放到存储器的数据集合

* DBMS (DataBase Management System)
- 数据库管理系统
- 用来操纵和管理数据库的服务软件

* DBS (DataBase System)
- 数据库系统:即DB+DBMS
- 指带有数据库并整合了数据库管理软件的计算机系统


### 相关参数
* 软件安装后自动创建相关目录与文件

| 文件          | 说明                |
| ------------- | ------------------- |
| /etc/my.cnf   | 主配置文件          |
| /var/ib/mysql | 数据库目录          |
| 默认端口号    | 3306                |
| 进程名        | mysąld              |
| 传输协议      | TCР                 |
| 进程所有者    | mysql               |
| 进程所属组    | mysql               |
| 错误日志文件  | /var/log/mysqld.log |


### 环境准备

1. 创建新虚拟机1台
2. 关闭firewalld
3. 禁用SELinux
4. 配置yum源
5. 配置IP地址192.168.4.50
6. 软件mysq-5.7.1
7. tar官网地址 http://dev.mysql.com/downloads/mysql


```shell
systemctl stop firewalld.service 
setenforce 0
tar -xf mysql-5.7.17.tar
yum -y install mysql-community-*.rpm
rpm -qa | grep mysql
systemctl start mysqld
systemctl enable mysqld
netstat -anptu | grep :3306
ls /var/lib/mysql
```

### 连接数据库，使用初始密码登录并重置密码

```sql
grep password /var/log/mysqld.log
mysql -uroot -p'qg1wpZ;G+deg'
	show databases;    -- 报错,需要重置密码
	alter user root@localhost identified by "123Qqq...";    -- 重置密码
	show databases;	    -- 成功
	exit
mysql -uroot -p123Qqq...
```

修改密码策略

| 策略名称   | 验证方式                                  |
| ---------- | ----------------------------------------- |
| LoW(0)     | 长度                                      |
| MEDIUM(1)  | 长度；数字，小写/大写，和特殊字符         |
| STRONG (2) | 长度；数字，小写/大写和特殊字符；字典文件 |


```shell
#永久配置
vim /etc/my.cnf
	[mysqld]
	validate_password_policy=0
	validate_password_length=6
```

```sql
mysql -uroot -p123Qqq...
	show variables like "%password%";    -- 查看变量
	set global validate_password_policy=0;    -- 修改密码策略
	set global validate_password_length=6;    -- 修改密码长度
	alter user root@localhost identified by "123456";    -- 重置密码
	exit
mysql -uroot -p123456
```


## 连接 mySQL 服务

* 客户端连接MySQL服务的方法
	- 命令行
	- 图形工具软件(软件自带图形界面、web页面)
	- 编写脚本(php, Java, python ..)

* 使用 mysql 命令
	- mysql -h服务器IP -u用户名 -p密码 [数据库名]
	- quit 或 exit #退出

登录时直接切换到mysql库

```sql
mysql -uroot -p123456 mysql
	select database();    -- 查看当前所处的数据库
```


### 数据存储流程

* 客户端把数据存储到数据库服务器上的步骤
	- 连接数据库服务器
	- 建库(类似于文件夹)
	- 建表(类似于文件夹)
	- 插入记录(类似于文件内容)
	- 断开连接


### SQL命令使用规则

* SQL命令不区分字母大小写(密码、变量值除外)
* 每条SQL命令以 `;` 结束
* 默认命令不支持 `Tab键` 自动补齐
* `\c` 终止sql命令

### 常用的SQL命令分类
* 管理数据库使用SQL (结构化查询语言)
* DDL 数据定义语言如：create、alter、drop
* DML 数据操作语言如：insert、update、delete
* DCL 数据控制语言如：grant、revoke
* DTL 数据事务语言如：commit、rollback、savepoint

## mysql基本操作
> 库管理命令：库类似于文件夹,用来存储表

* 可以创建多个库,通过库名区分

```sql
show databases;	-- 显示已有的库
select user();	-- 显示连接用户
use 库名;	-- 切换库
select database();	-- 显示当前所在的库
create database 库名;	-- 创建新库
show tables;	-- 显示已有的表
drop database 库名;	-- 删除库
```

```sql
mysql -uroot -p123456 mysql

create database bbsdb;
create database BBSDB
show databases;
drop database BBSDB;    -- 删除库
use bbsdb;    -- 切换库
select databse();    -- 显示当前所在库
select user();    -- 显示连接用户
show tables;    -- 显示已有的表
```



### 表管理命令

#### 创建表

* 表存储数据的文件

```sql
create table 库名.表名(
	字段名1 类型(宽度),
	字段名2 类型(宽度)
	.......
) DEFAULT CHARSET=utf8;	-- 指定中文字符集,可以给字段慰值中文
```

```sql
mysql -uroot -p123456 mysql

use bbsdb;
select database();
create table user(name char(10), age int, homedir char(20));
show tables;
desc user;
select * from bbsdb.user;
select * from user;
insert into bbsdb.user values("tom", 18, "beijing");
select * from user;
insert into user values("abc", 20,"chifeng");
select * from user;
select name from user; 
select name,age from user;
```


#### 修改、删除表

```sql
update bbsdb.user set homedir="china";
select * from user;	-- 更新表数据
delete from bbsdb.user;	-- 删除表数据,但表还在
show tables;
select * from user;
drop table bbsdb.user;	-- 删除表
show tables;
create table user(name char(10), age int, homedir char(20));
show tables;
show create table bbsdb.user\G
create table 学生表(姓名 char(15), 地址 varchar(20)) DEFAULT CHARSET=utf8; -- 设置字符集为utf8,支持中文
show tables;
show tables;
desc 学生表;
insert into 学生表 values("张三峰", "武当山");
select * from 学生表;
```

### 数据类型：
#### 常见信息种类

> 数值型：体重、身高、成绩、工资
> 字符型：姓名、工作单位、通信地址
> 枚举型：兴趣爱好、性别、专业
> 日期时间型：出生日期、注册时间

#### 字符类型

* 定长：char(字符个数）
    - 最大字符个数255
    - 不够指定字符个数时在右边用空格补全
    - 字符个数超出时，无法写入数据。

* 变长：varchar(字符个数）
    - 按数据实际大小分配存储空间
    - 字符个数超出时，无法写入数据。

* 大文本类型：text/blob
    - 字符数大于65535存储时使用


```sql
create table  t1(name char(5), email varchar(15));
desc t1;
create table t2( name char, email varchar(3) ); -- char类型不指存储几个字符，默认存储一个
desc t2;
insert into t2 values("a", "bac");  -- 成功
insert into t2 values("aa", "bacd");    -- 失败2
insert into t2 values("b", "bacd"); -- 失败
select * from t2;
```

#### 数值类型
##### 整数型：只能存整数

| 类型 | 名称 | 有符号范围 | 无符号范围 |
| tinyint | 微小整数 | -128~127 | 0~255 |
| smallint | 小整数 | -32768~32767 | 0~65535 |
| mediumint | 中整型 | -223~223-1 | 0~224-1 |
| int | 大整型 | -231~231-1 | 0~232-1 |
| bigint | 极大整型 | -263~263-1 | 0~264-1 |
| unsigned | 使用无符号存储范围 | | |

创建一张表 t3，用于存储学生信息(用户名，年龄，等级)，tinyint 类型，unsigned 无符号存储(0~255)，默认有符号存储(-128~127)

```sql
create table t3(name char(15), age tinyint unsigned, level tinyint);
insert into t3 values("bob", 21, 7); #成功
insert into t3 values("tom", -1, -129); #失败，条件不满足
insert into t3 values("tom", 0, -129); #失败，超出范围
insert into t3 values("tom", 0, -127); #成功
存储小数，会四舍五入
insert into t3 values("jim", 21.5, 3); #21.5四舍五入存为22
select * from t3;
insert into t3 values("jim", 21.5, 3.43); #3.43四舍五入存为3
select * from t3;3
```

##### 浮点型：存储有小数点的数

| 类型 | 名称 | 有符号范围 | 无符号范围 |
| —- | —- | —- | —- |
| float | 单精度 | -3.402823466E+38到1.175494351E-38 | -1.175494351E-38到3.402823466E+38 |
| double | 双精度 | -1.7976931348623157E+308到2.2250738585072014E-308 | -22250738585072014E-308 到1.7976931348623157E+308 |

```sql
float(7,2)  -- 7 指整个浮点数的最大位数，2 指 7 位数字中有两位是小数位, 则取值范围 为：
-99999.99 ~ 99999.99
float(5,3)     -- 5 指整个浮点数的最大位数，3 指 5 位数字中有三位是小数位, 则取值范围为：-
99.999 ~ 99.999
float(数字 1,数字 2)    -- 数字 1：总的位数 数字 2：小数位的个数
```

```sql
create table t4(name char(10), pay float(5,2));
insert into t4 values("john", 1000.88); -- 失败，超出范围
insert into t4 values("john", 999.88);  -- 成功
insert into t4 values("john", -999.99); -- 成功
select * from t4;
insert into t4 values("john3", 218);    -- 存储整数，小数位默认补0
```

### 日期时间类型
#### 类型格式

创建与日期时间相关的表，指定名称，年份，上课时间，生日，聚会时间

```sql
create table t5(name char(15), s_year year, uptime time, birthday date, party datetime);
insert into t5 values("bob", 1990,083000, 20231120, 20230214183000);
select * from t5;
```

### 时间函数


```sql
select curtime();     —- 获取当前的系统时间
select curdate();     —- 获取当前的系统日期5
select now();     —- 获取当前的系统日期和系统时间
select year(now());     —- 从当前系统时间中只取出年份
select month(now());     —- 从当前系统时间中只取出月份
select day(now());     —- 从当前系统时间中只取出天数
select date(now());     —- 从当前系统时间中只取出年月日
select time(now());     —- 从当前系统时间中只取出时分秒
```

```sql
—- 根据时间函数在 t5 表中插入一条数据
insert into t5 values("tom",2000,time(now()),curdate(),now());
select * from t5;
```

### 日期时间字段 datetime 与 timestamp 的区别

关于日期时间字段：当未给timestamp字段赋值时，自动以当前系统时间赋值，而datetime值为NULL（空）

```sql
—- 创建 t6 表，指定姓名，约会时间，聚会时间，验证 timestamp 和 datetime 的区别
create table t6(name char(10), meetting datetime, party timestamp);
insert into t6 values("bob", now(), now());     —- 两个字段都有值
select * from t6;
```

```sql
—- t6 表中重新插入一条数据，只插入 name 和 metting 字段的值，party 字段采用默认值
insert into t6(name,meetting) values("bob", 20231120224058);
select * from t6;    —- party字段同样有值，字段类型为timestamp，用当前系统时间
```

```sql
—- t6 表中重新插入一条数据，只插入 name 和 party 字段的值，meetting 字段采用默认值
insert into t6(name,party) values("john", 19731001223000 );
select * from t6;     —- meetting字段类型为datetime，没有指定时间，默认为空NULL)
```


### year 类型

要求使用 4 位赋值6

当使用 2 位数赋值时：01-99

01 ~ 69 视为 2001 ~ 2069

70 ~ 99 视为 1970 ~ 1999


```sql
—- 插入数据，只给 t5 表中的 s_year 字段赋值
show tables;
desc t5;
select s_year from t5;
insert into t5(s_year) values(03),(81);
select s_year from t5;     —- 查看t5表中s_year字段的数据，验证结果
```

### 枚举类型

字段的值不能自己输入，必须在设置的范围内选择(有单选和多选之分)

#### enum 单选

格式：字段名 enum（值 1，值 2，值 N）

仅能在列表里选择一个值


### set 多选

格式：字段名 set(值 1，值 2，值 3)

在列表里选择一个或多个值

```sql
—- 创建 t7 表，指定字段：姓名(name)，性别(sex)，爱好(likes)
create table t7(name char(15), sex enum("boy", "girl", "no"), likes set("eat","money", "game", "music"));
desc t7;
insert into t7 values('bob','boy','eat,game,music');     —- 成功
Select * from t7;7
insert into t7 values('bob','man','girl,book');     —- 字段sex的类型中没有man,存储失败
insert into t7 values('bob','no','girl,book');     —- 字段likes的类型中没有girl和book,存储失败，使用类型enum(单选)，set(多选)，值必须在其范围之内

## 约束条件：
### 作用

限制字段赋值

​```sql
desc t1;

Null Key Default Extra     —- 这四列为约束条件
Null     —- 指是否允许为字段赋空值；
         —-  YES，允许给字段赋空值，默认也是允许赋空值；
         —-  NO， 不允许给字段赋空值；
Key：键值
Default    —- 当不给字段赋值时，则使用默认值，初始默认值为 NULL，可以修改
Extra     —- 额外的设置, 例如：可以设置学号为自动增长的

### 设置约束条件

| null | 允许为空（默认设置） |
| —- | —- |
| not null | 不允许为 null（空）|
| key | 键值类型 |
| default | 设置默认值，缺省为 NULL |
| extra | 额外设置 |



#### 环境准备：

​```sql
create database test;
use test;
create table t1(name char(15), s_year year, uptime time, birthday date, party datetime);2
insert into t1 values("bob", 1990,083000, 20231120, 20230214183000);
insert into t1 values("tom",2000,time(now()),curdate(),now());
insert into t1(s_year) values(03),(81);
select * from t1;
create table t2(name char(15), sex enum("boy", "girl", "no"), likes set("eat","money", "game", "music"));
desc t2;
```


#### 验证约束条件 Null,可以给字段赋空值

```sql
insert into t2 values ('bob','boy','eat,game');
select * from t2;
insert into t2 values (null,null,null);     —-  t2表中可以插入null（没有数据）
select * from t2;
insert into t2(name) values ('tom');     —- 只给name字段赋值，其他字段会使用默认值赋值
select * from t2;
```

#### 建表时指定字段值不为空和设置默认值

```sql
create table t3( name char(10) not null, age tinyint unsigned default 18, class char(8) not null default 'NSD2006');
desc t3;
insert into t3(name) values("john");     —- 只插入name字段，则其他字段采用默认值
select * from t3;
```


#### 向t3表中插入数据，所有字段自己定义，可以不使用默认值

```sql
insert into t3 values("tom", 29, "nsd2003");
select * from t3;
```

#### 验证 null 值和"null"值

null 指的是没有任何的数据3
"null" 指的是有数据，但数据的内容为"null"

```sql
desc t3;
insert into t3 values(null,null,null);     —-  name字段不能为空，存储失败
insert into t3 values("null",null,null);     —- 给name字段加引号，不代表空值，而是代表字符串，存储失败，class 字段不能为空
insert into t3 values("null",null,"");     —-  class字段直接加引号，不为空，是0个字符
select * from t3;
```

### 修改表结构：
#### 语法结构：

##### 用法：
```sql
alter table 库名.表名 执行动作;
```

#### 执行动作：

> add：添加新字段
>
> modify：修改字段类型
>
> drop：删除字段
>
> change：修改字段名
>
> rename：修改表名


### 添加新字段

#### 用法
    —- 新字段默认添加在字段末尾
```sql
alter table 库名.表名
add 字段名 类型(宽度) 约束条件 [after 字段名 | first];
```


向 t1 表中插入一个字段 email, 不为空，默认值为"stu@tedu.cn"，不指定表字段的位置，默认会插入到表的最后

```sql
desc t1;
alter table t1 add email varchar(30) not null default "stu@tedu.cn";
desc t1;     —-  email字段在最下方
select * from t1;     —- t1表中的数据也会多出一行，值为默认值
```

向 t1 表的最前面插入一个字段 stu_id, 约束条件采用默认系统设置

```sql
alter table t1 add stu_id char(9) first;
desc t1;     —-  stu_id字段位于表的首位
select * from t1;     —-  stu_id没有指定默认值，默认为NULL
```

在 t1 表中的 name 字段后，插入一个新字段 sex，类型为枚举类型，默认值为：boy

```sql
alter table t1 add sex enum("boy", "girl") default "boy" after name;
desc t1;     —-  sex字段位于name字段的后面
select * from t1;     —- 多出一列sex,默认值为boy
```

### 修改字段类型

#### 基本用法

 - 修改的字段类型不能与已存储的数据冲突

```sql
alter table 库名.表名
modify 字段名 类型(宽度) 约束条件 after 字段名 | first];
```


修改 t1 表的 sex 字段，设置默认值为 man

```sql
alter table t1 modify sex enum("man", "woman") default "man";#修改失败，字段里需要包含原表中的数据类型boy,否则冲突
alter table t1 modify sex enum("man", "woman", "boy") default "man"; #修改成功，sex字段中存在和表中数据相同的类型'boy'5
desc t1;
```

修改 t1 表中的 name 字段类型，修改为 varchar(15)

```sql
desc t1;
alter table t1 modify name varchar(15);
desc t1;
```

##### 使用 modefy 实现字段值的位置调换

将 email 字段移到 sex 字段的后面


alter table t1 modify email varchar(30) not null default "stu@tedu.cn" after sex;
desc t1;
select * from t1; #数据不发生变化


### 删除字段
#### 基本用法
- 表中有多条记录时，所有列的此字段的值都会被删除
```sql
after table 库名.表名 drop 字段名;
```


删除 t1 表中的字段 stu_id

```sql
select * from t1;
alter table t1 drop stu_id;
select * from t1;
desc t1;
```

删除 t1 表中的多个字段(email 和 party)

```sql
alter table t5 drop email,drop party;6
```

### 修改字段名
#### 基本用法

```sql
after table 库名.表名 change 原字段名 新字段名 类型 约束条件;
```


修改 t1 表中 s_year 的字段名，使用 change 命令将字段 s_year 的名字改为 abc

```sql
alter table t1 change s_year abc year;
```


### 修改表名
#### 基本用法
 - 表对应的文件名，也被改变
 - 表记录不受影响

```sql
after table 表名 rename 新表名;
```

使用rename命令来修改t5表的表名为stuinfo

```sql
alter table t1 rename stuinfo;
show tables;
```


## Mysql 键值概述

根据数据存储要求，选择键值

| index | 普通索引 |
| —- | —- |
| unique | 唯一索引 |
| fulltext | 全文索引 |
| primary key | 主键 |
| foreign key | 外键 |

> index、primary key、foreign key #生产环境一定会用到的键值类型

### 索引介绍

> 类似于书的目录
>
> 对表中字段值进行排序
>
> 索引算法：Btree、B+tree、hash

#### Btree 算法(二叉树)：


1. 查找数字 5 时，先用数字 5 和数字 4 对比；
2. 当数字 5 大于数字 4，则直接从数字 4 的右分支进行查找；
3. 接下来用要查找的数字 5 和数字 6 对比；2
4. 当数字 5 小于数字 6，则直接从数字 6 的左分支进行查找；
5. 按照以上的方式继续比对查找，直到查找到数据为止；

### 索引的优缺点

> 生产环境下，对数据查的请求远远高于对数据写的请求；

### 普通索引 index

使用规则

### 创建索引

> 建表的时候创建索引：index(字段名), index(字段名)....
>
> 创建 t1 表时，将 name 字段和 class 字段设置为索引


```sql
create table t1(name char(10), class char(9), sex enum("m", "w"), index(name),index(class));
desc t1;    —- 约束条件Key变为MUL(索引的标志)
```

```sql
在已有的表里创建索引：

​```sql
create index 索引名 on 表名(字段名);
```

```sql
create table t2 ( name char(16), pay float(5,2) );
desc t2;
```

在已有表 t2 表中为字段创建索引 xxx(索引名称可以随便定义)

```sql
create index xxx on t2(name);
desc t2;
```

### 查看索引

语法格式：
```sql
show index from 表名 \G;
```

```sql
show index from t1\G;
    *************************** 1. row ***************************
    Table: t9    —- 表名
    Non_unique: 1
    Key_name: name    —- 索引名
    Seq_in_index: 1
    Column_name: name    —- 字段名
    ...
```


### 删除索引

语法格式：

```sql
drop index 索引名 on 表名;
```

删除 t1 表中的索引 name

```sql
drop index name on t1;
desc t1;
show index from t1\G;4
```

## MySQL 主键 primary key：

### 创建主键
#### 主键的作用：限制字段赋值


#### 主键的使用规则

> 创建表时，表中存在类似身份证号，编号等时，将表中的该字段设置为主键，让其不能重复，可以自动增长。

#### 创建主键

> 建表时创建主键，命令：`primary key`(字段名)
>
> 创建 t3 表，字段有：姓名(name)，年龄(age) ，将 name 字段设置为主键 primary key

```sql
create table t3(name char(10) primary key, age int);
desc t10;    —- 查看t3表的表结构，key的值为PRI，则代表该字段为主键,在表t3中插入数据，主键所在的字段，数据不能重复，不允许有空值
insert into t3 values("bob",29);    —- 成功
insert into t3 values("bob",39);     —- 失败，主键字段的数据重复
insert into t3 values("jim",19);     —- 成功
insert into t3 values(null,29);     —- 失败，主键所在的字段值不能为NULL值
insert into t3 values("null",39);     —- 成功，加引号代表的是字符串5
insert into t3 values("",59);     —- ””指没有内容，不代表null
select * from t3;
```

> 在已有表里创建主键

语法格式：　
```sql
alter table 表名 add primary key(字段名列表);
```

> 将表中的字段设置为主键时，则表中该字段的值不能为空，也不能重复，否则添加失败; 表中没有数据时，添加成功

```sql
select * from t1;
desc t1; #查看t1表的表结构，原先没有主键，允许数据重复
alter table t1 add primary key(name); #将t1表中的字段name设置为主键
desc t1;
```

### 删除主键

语法格式：
```sql
alter table 表名 drop primary key;
```

删除 t1 表的主键

```sql
alter table t1 drop primary key;
desc t1; #主键消失，但是name字段的约束条件不许为空，可以重复插入数据
insert into t1 values('bob','NSD2001','m'); #成功
insert into t1 values('bob','NSD2002','m'); #成功
insert into t1 values(null,'NSD2002','m'); #失
```











```sql
create table yg(yg_ id int primary key auto increment,name char(15))engine=innodb;
desc yg;
insert into yg(name) values('bob);
insert into yg(name) values('tom");
select * from yg;
create table gz(
gz_id int,
pay float(5,2),
foreign key(gz id) references yg(yg id) on update cascade on delete cascade)engine=innodb;
show create table gz\G	-- 通过查看建表过程，来查看表是否创建
```

外键外键设置成功之后，gz (工资表)插入数据时，编号必须在yg (员工表)的yg_id范围之内
```sql
select * from ygi
insert into gz values(1,300.00);
insert into gz values(2,500.00);
insert into gz values(3,300.00);	-- 插入失败,编号必须在yg (员工表)编号范围之内
```


在yg表里插入一条记录，用户名为john，编号采用自增长
```sql
insert into yg(name) values(john);
select * from yg
```


在gz表里插入记录,是否可以插入
```sql
insert into gz values(3,300.00);
select * from gz;
```

### 测试同步删除和同步更新
```sql
delete from yg where yg_id=3;
select * from yg;
select from gz;
update yq set yg id=6 where name="tom"
select * from yg;
select * from gz;
```


### 设置成外键的表字段也必须将其设置为主键,否则会出现对于同一个编号可以插入多次数据的情况,也会出现编号为null,插入数据同样成功的情况

```sql
desc gz;
insert into gz values(1,200.00);
insert into gz values(6,200.00);
select * from gz;
insert into gz values(null,200.00);
select * from gz;
```

### 将表中的外键字段设置为主键

```sql
delete from gz;
select * from gz;
alter table gz add primary key(gz id);
desc gz;
insert into gz values(null,200.00);
insert into gz values(1,200.00);
insert into gz values(1,200.00);
insert into gz values(6,200.00);
insert into gz values(6,200.00);
insert into gz values(7,200.00);
```

###删除表当一个表被其他表所依赖时,该表则不可以被删除删除方法有2种:
> 1. 删除表中的外键
> 2. 先删除gz (工资表)

```sql
drop table yg;#直接删除失败
```

### 删除外键：

语法格式：

```sql
alter table 表名 drop foreign key 名称;
```

```sql
show create table gz\G
alter table gz drop foreign key gz_ibfk_1;
show create table gz\G 
drop table yg;
```

### 构建mysq图形管理界面

```shell
yum -y install httpd
systemctl start httpd
yum -y install php php-mysql
tar -xf phpMyAdmin-2.11.11-all-languages.tar.gz
ls phpMyAdmin-2.11.11-all-languages
mv phpMyAdmin-2.11.11-all-languages /var/www/html/phpmyadmin
ls /var/www/html/
ls /var/www/html/phpmyadmin/
cd /var/www/html/phpmyadmin/
cp config.sample.inc.php config.inc.php

vim config.inc.php
	17 $cfg['blowfish_secret'] = 'wj123';	#指定COOKIE的值，做认证，自定义
	31 $cfg['Servers'][$i]['host'] = 'localhost';	#指定数据库服务器的地址


systemctl restart httpd
firefox http://192.168.4.10/phpmyadmin
```



### 范围匹配

| in (`值列表`)             | 在....里     |
| ------------------------- | ------------ |
| not in (`值列表`)         | 不在...里... |
| between `数字` and `数字` | 在...之间…   |

举例：
```sql
select name,uid from user where name in("mysql","bin","null");
select name,uid from user where uid in(3,6,9,15);
select name,shell from user where shell not in("/bin/bash","/sbin/nologin")
select name,uid from user where uid between 15 and 30;
select name,uid from user where uid between 15 and 100;
select id,name,uid from user where id between 10 and 13;
```

#### 逻辑匹配


多个条件判断时使用


| or     | 逻辑或     | 有一个条件成立即可     |
| ------ | ---------- | ---------------------- |
| and    | 逻辑与(且) | 所有条件都要成立才可以 |
| !或not | 逻辑非     |                        |

举例
```sql
select name,uid from user where name="root" and shell ="/sbin/nologin";
select name,uid from user where name="root" and shell="/bin/bash";
select name,uid from user where name="root" or shell="/sbin/nologin";
select name,uid,shell from user where name="root" or shell="/sbin/nologin";
select name,uid,shell from user where shell !="/bin/bash";

select name,uid,shell from user where shell="/bin/bash";
select name,uid,shell from user where shell in ("/bin/bash","/sbin/nologin");
select name,uid,shell from user where shell not in ("/bin/bash","/sbin/nologin");
```



### 高级匹配条件

#### 模糊查询

格式: where 字段名 like "通配符"

| _    | 表示1个字符   |
| ---- | ------------- |
| %    | 表示0-n个字符 |

```sql
select name from user where name like "_";
select name from user where name like "____";
select name from user where name like "%a%";
select name from user where name like "a%";
select name from user where name like "__%__";
```



#### 正则表达式格式

> 格式: ` where 字段 regexp "正则表达式" `
>
> 正则元字符: `^` `$` `.` `[]` `*` `|`

| ^          | 匹配输入字符串的开始位置                                     |
| ---------- | ------------------------------------------------------------ |
| $          | 匹配输入字符串的结束位置                                     |
| .          | 匹配除 "\n" 之外的任何单个字符                               |
| [...]      | 字符集合。匹配所包含的任意一个字符。例如， '[abc]' 可以匹配 "plain" 中的 'a' |
| *          | 匹配前面的子表达式零次或多次。例如，zo* 能匹配 "z" 以及 "zoo"。* 等价于{0,} |
| p1\|p2\|p3 | 匹配 p1 或 p2 或 p3。例如，'z\|food' 能匹配 "z" 或 "food"。'(z\|f)ood' 则匹配 "zood" 或 "food" |

```sql
select name from user where name regexp "^r";
select name from user where name regexp "^a";
select name from user where name regexp "^a|t$";;
select name from user where name regexp "^r.*t$";
select name from user where name regexp "[0-9]";
insert into user(name) values("haha99"),("66haha"),("6xixi"),("ya7ya");
select name from user;
select name from user where name regexp "[0-9]";	-- 查询user表用户名包含数字的name字段
```




```sql
select id,name,uid from user where id<=5;
update user set uid=uid+1 where id<=5;
select id,name,uid from user where id <=5;
update user set uid=uid-1 where id<=5;
select id,name,uid from user where id<=5;
select name,uid from user where id<=5;
select name,uid from user where uid % 2=0;
select name,uid from user where uid % 2 !=0;
select name,uid,gid from user where name="halt";
select name,uid,gid,(uid+gid)/2 from user where name="halt";	-- 显示uid和gid的平均值,默认以算法作为临时字段名
alter table user add age tinyint unsigned default 20 after name;
desc user;
select * from user;
select name,age,2023-age start_y from user where name="root";	-- start_y临时字段名
```



### 聚集函数

> MySQL内置数据统计函数(字段必须是数值类型)

| avg(字段名) | 统计字段平均值 |
| sum(字段名) | 统计字段之和 |
| min(字段名) | 统计字段最小值 |
| max(字段名) | 统计字段最大值 |
| count(字段名) | 统计字段值个数 |

举例
```sql
select avg(uid) from user;
select sum(uid) from user;
select min(uid) from user;
select max(uid) from user;
select count(*) from user;
select count(*) from user where name like "___";
select count(name) from user where name like "___";
```



### 排序

> 格式: SQL查询 order by 字段名 [asc|desc] 升序|降序

```sql
select name,uid from user where uid>=10 and uid<=200;
select name,uid from user where uid>=10 and uid<-200 order by uid;
select name,uid from user where uid>=10 and uid<=200 order by uid desc;
```


### 分组

> 格式: SQL查询 group by 字段名

```sql
select shell from user where uid<500;
select shell from user where uid<500 group by shell;
```

> 去重显示格式: select distinct 字段名 from 表名

```sql
select distinct shell from user where uid<500;
```


### 限制查询结果

> 显示行数用法


> SQL查询limit数字;	//显示查询结果前多少条记录
>
> SQL查询limit数字1,数字2;	//显示指定范围内的查询记录

数字1 起始行(0表示第1行)

数字2 总行数

```sql
select name,uid,gid from user limit 3;
select name,uid,gid from user limit 3,3;
```


查询user表中gid最大的前5个用户使用的shell

```sql
select name,gid,shell from user order by gid desc limit 5;
```

把gid最小的前5个用户信息保存到/myload/min5.txt文件里

```sql
select name,gid,shell from user order by gid limit 5 into outfile "/var/lib/mysql-files/min5.txt";
system cat /var/lib/mysql-files/min5.txt 1
```



## 用户授权
### grant 授权

> 授权：添加用户并设置权限

命令格式

```sql
-- 客户端
grant 权限列表 on 库名 to 用户名@"客户端地址"
	identified by "密码"	-- 授权用户密码
	with grant option;	-- 有授权权限，可选项

grant all on db4.* to yaya@"%" identified by"123qqq...A"; 
```

#### 权限列表

> all	-- 所有权限
>
> usage	-- 无权限
>
> select,update,insert	-- 个别权限
>
> select, update (字段1, .字段N)	-- 指定字段库名

#### 库名

> *.*	-- 所有库所有表
>
> 库名.*	-- —个库
>
> 库名.表名	-- 一张表 

* 用户名
 - 授权时自定义 要有标识性
 - 存储在mysql库的user表里

#### 客户端地址

> %	-- 所有主机
>
> 192.168.4.%	-- 网段内的所有主机
>
> 192.168.4.1	-- 1台主机
>
> localhost	-- 数据库服务器本机


##### 应用示例1
 - 添加用户mydba，对所有库、表有完全权限
 - 允许从任何客户端连接，密码123qqq...A
 - 且有授权权限

```sql
grant all on *.* to mydba@"%" 	dentified by "123qqq...A" with grant option; 
```

##### 应用示例2
 - 添加admin用户，允许从192.168.4.0/24网段连接，对db3库的user表有查询权限，密码123qqq...A
 - 添加admin2用户，允许从本机连接，允许对db3库的所有表有查询/更新/插入/删除记录权限，密码123qqq...A

```sql
grant select on db3.user to admin@"192.168.4.%" identified by "123qqq...A";
grant select,insert,update,delete on db3.* to admin2@"localhost" identified by "123qq...A"; 
```

#### 示例3：

> 添加用户mydba，对所有库所有表有完全权限，允许从任何客户端连接，密码为123qqq...A，且有授权权限

```sql
-- 虚拟机svr7操作
mysql -uroot -p'123qqq...A'
grant all on *.* to mydba@"%" identified by '123qq...A' with grant option;

``虚拟机pc207测试:
yum -y install mariadb
mysql -h192.168.4.7 -umydba -p'123qq...A' 
```


### 登录用户使用

```sql
select user();	-- 显示登录用户名及客户端地址
show grants;	-- 用户显示自身访问权限
show grants for用户名@"客户端地址";	-- 管理员查看已有授权用户权限
set password=password("密码");	-- 授权用户连接后修改连接密码
set password for用户名@"客户端地址"= password("密码");	-- 管理员重置授权用户连接密码
drop user 用户名@"客户端地址";	-- 删除授权用户(必须有管理员权限) 
```


示例：

虚拟机pc207

```shell
yum-y install mariadb
mysql -h192.168.4.7-umydba -p'123qqq...A'
```

```sql
select user();	-- 查看当前的登录用户及客户端地址
show grants;	-- 查看当前登录用户mydba所拥有的权限
```

虚拟机svr7
```sql
show grants for mydba@"%";	-- 管理员查看已有授权用户权限
```

虚拟机pc207
```sql
set password=password("456aaa...A");	-- 授权用户修改自己的连接密码
exit

mysql -h192.168.4.7 -umydba -p'456aaa...A'
exit	-- 使用新密码登录数据库
```

虚拟机svr7
```sql
set password for mydba@"%"=password("123qqq ..A");	-- 管理员重置授权用户连接密码
```

虚拟机pc207
```shell
mysql-h192.168.4.7 -umydba -p'123qqq...A'
```


#### 测试权限

pc207
```shell
mysql -h192.168.4.7 -umydba -p'123qqq...A'
```
```shell
show grants;
show databases
drop database test;
create database test;
create database bbsdb;
grant all on bbsdb.* to abc@"localhost" identified by '123qqq..A;	-- 用户mydba可以给其他用户授权虚拟机
```

svr7
```shell
mysql -uabc -p'123qq..A'
```
```shell
# 删除授权用户mydba (必须有管理员权限)
mysql -uroot -p '123qqq...A';
```
```sql
drop user mydba@"%";
```

pc207
```sql
mysql -h192.168.4.7 -umydba -p'123qqq...A'	-- 连接失败
```


##### 应用示例4:
- 添加admin用户，允许从192.168.4.0/24网段连接，对db3库的user表有查询权限,密码123qqq...A
- 添加admin2用户，允许从本机连接，允许对db3库的所有表有查询/更新/插入/删除记录权限，密码123qqq...A

```sql
grant select on db3.user to admin@"192.168.4.%" identified by "123qqq...A";
grant select,insert,update,delete on db3.* to admin2@"localhost" identified by "123qqq...A"; 
```

svr7
```sql
mysql -uroot -p'123qqq...A'
```

添加admin用户，允许从192.168.4.0/24网段连接，对db3库的user表有查询权限，密码为123qqq...A
```sql
grant create,select on db3.user to admin@"192.168.4.%" identified by '123qqq...A';	-- 给用户授权时如果不是all权限,当对应的库和表不存在时必须有create权限
```
添加admin2用户,允许从本机连接,对db3库的所有表有查询/更新/插入/删除权限,密码为123qqq...A
```sql
grant create,select,update,insert,delete on db3.* to admin2@"localhost" identified by '123qqq...A';
create database db3;
exit
```
pc207：测试admin用户的权限
```sql
mysql -h192.168.4.7 -uadmin -p'123qqq...A'
show grants;
create table db3.user(name char(50),sex enum("m","w");
select * from db3.user;
insert into db3.user values("bob","m");	-- 插入失败
```
svr7：测试admin2用户的权限,只能从本机登录
```sql
mysql -uadmin2 -p'123qqq...A'
show grants;
use db3;
show tables;
insert into db3.user values("bob","m");
select * from user;
delete from user;
create table t1(id int);
```


### 授权库

mysql库记录授权信息,主要表如下:

| user表         | 记录已有的授权`用户`及权限           |
| -------------- | ------------------------------------ |
| db表           | 记录已有授权用户对`数据库`的访问权限 |
| tables_priv表  | 记录已有授权用户对`表`的访问权限     |
| columns_priv表 | 记录已有授权用户对`字段`的访问权限   |

`查看表记录可以获取用户权限;也可以通过更新记录,修改用户权限`


* mysql库记录授权信息,主要表如下:

| user表         | 记录已有的授权用户及权限           |
| -------------- | ---------------------------------- |
| db表           | 记录已有授权用户对数据库的访问权限 |
| tables_priv表  | 记录已有授权用户对表的访问权限     |
| columns_priv表 | 记录已有授权用户对字段的访问权限   |

```sql
mysql -uroot-p'123qq...A'
select user,host from mysql.user;
show grants for admin@"192.168.4.%";	-- 查看admin用户的权限
select * from mysql.user where host="192.168.4.%" and user="admin"\G
select * from mysgl.tables priv where host="192.168.4.%" and user="admin"\G
desc mysql.tables priv\G
update mysql.tables_priv set Table_priv="select,create,insert,update" where user="admin" and host="192.168.4.%";	-- 通过改表字段的值修改授权用户权限
flush privileges;	-- 刷新，让配置生效
select * from mysql.tables_priv where host="192.168.4.%" and user="admin"\G 
show grants for admin@"192.168.4.%";
desc mysql.db;
select host,db,user from mysgl.db;
select * from mysql.db where db="db3"\G
show grants for admin2@"localhost";
update mysql.db set Delete_priv="N" where user="admin2";
flush privileges;
show grants for admin2@"localhost";
select * from mysql.db where db="db3"\G 
desc mysql.columns_priv;
select * from mysql.columns_priv;
grant select,update(name) on db3.user to admin2@"localhost" identified by "123qqq...A";
select * from mysql.columns_priv;
show grants for admin2@"localhost";
```




### 撤销权限
* 命令格式
revoke 权限列表 on 库名.表 from 用户名@"客户端地址";

```sql
REVOKE insert,drop ON test.* FROM sqler02@'localhost';
```




```sql
select host,user from mysql.user;
show grants for admin@"192.168.4.%";
revoke update,create on db3.user from admin@" 192.168.4.%";
show grants for admin@"192.168.4.%";
select * from mysgl.tables priv where user='admin"\G
select host,user from mysql.user;
show grants for admin2@"localhost";
revoke insert,update on db3.* from admin2@"localhost";
show grants for admin2@"localhost";
revoke all on db3.* from admin2@"localhost";
show grants for admin2@"localhost";
revoke all on db3.user from admin2@"localhost";
show grants for admin2@"localhost";
drop user admin2@"localhost";
exit
```































## 6.8 练习
### 案例1：构建mysql服务
1. 虚拟机svr7上构建mysql数据库服务

```shell
systemctl stop firewalld.service 
setenforce 0
tar -xf mysql-5.7.17.tar
yum -y install mysql-community-*.rpm
systemctl start mysqld
systemctl enable mysqld
```

2. 数据库管理员密码设置为tarena

```shell
vim /etc/my.cnf
	validate_password_policy=0
	validate_password_length=6

grep password /var/log/mysqld.log
```

```sql
mysql -uroot -p'mysqld.log中的密码'
	set global validate_password_policy=0;
	set global validate_password_length=6;
	alter user root@localhost identified by "tarena";
	exit
mysql -uroot -ptarena
```

### 案例2：数据库基本原理
1. 使用mysql命令连接数据库，并查看连接用户

```sql
mysql -uroot -ptarena
	select user();
```

2. 创建数据库名为test

```sql
create database test;
use test;
```

3. 在数据库test下创建一个名为stu的表，表记录包含如下内容：
      学号，姓名，性别，手机号，通信地址  （注：性别用enum类型）

```sql
create table stu(学号 char(10), 姓名 char(15), 性别 enum('男','女'), 手机号 char(11), 通信地址 varchar(20)) DEFAULT CHARSET=utf8;
```

4. 往stu表里添加如下记录：

| 学号      | 姓名   | 性别 | 手机号      | 通信地址         |
| --------- | ------ | ---- | ----------- | ---------------- |
| NSD131201 | 张三   | 男   | 13012345678 | 朝阳区劲松南路   |
| SD131202  | 李四   | 男   | 18722223333 | 海淀区北三环西路 |
| NSD131203 | 韩梅梅 | 女   | 18023445678 | 东城区珠市口     |

```sql
insert into stu values("NSD131201","张三","男",13012345678,"朝阳区劲松南路");
insert into stu values("NSD131202","李四","男",18722223333,"海淀区北三环西路");
insert into stu values("NSD131203","韩梅梅","女",18023445678,"东城区珠市口");
select * from stu;
```

5. 删除stu表记录

```sql
delete from test.stu;
select * from stu;
```

6. 删除stu表

```sql
drop table test.stu;
show tables;
```

7. 删除test库

```sql
drop database test;
show databases;
```


​    

## 6.11练习
### 案例1：构建mysql服务器
要求如下：
1. 在虚拟机svr7上构建mysql服务

```sql
systemctl stop firewalld.service 
setenforce 0
tar -xf mysql-5.7.17.tar
yum -y install mysql-community-*.rpm
rpm -qa | grep mysql
systemctl start mysqld
systemctl enable mysqld
netstat -anptu | grep :3306
ls /var/lib/mysql
```

2. 设置数据库管理员root本机登录密码为redhat

```shell
vim /etc/my.cnf
	validate_password_policy=0
	validate_password_length=6

grep password /var/log/mysqld.log
```

```sql
mysql -uroot -p'mysqld.log中的密码'
	show variables like "%password%"; 
	set global validate_password_policy=0;
	set global validate_password_length=6;
	alter user root@localhost identified by "redhat";
	exit
mysql -uroot -predhat
```

### 案例2：SQL命令练习
1. 连接到数据库

```sql
mysql -uroot -predhat
```

2. 查看所有的数据库

```sql
show databases;
```

3. 创建数据库名为tedu，test


```sql
create database tedu;
create database test;
```

4. 切换到数据库tedu


```sql
use tedu;
```

5. 显示当前在哪个数据库


```sql
select database();
```

6. 显示连接的用户


```sql
select user();
```

7. 删除数据库tedu

```sql
drop database tedu;
show databases;
```

8. 创建stu表，表字段包含name，homedir

```sql
create table stu(name char(10), homedir varchar(20));
```

9. 往stu表里添加记录为jim，usa；lilei，china


```sql
insert into stu values("jim", "usa");
insert into stu values("lilei", "china");
```

10. 查看表记录


```sql
select * from stu;
```

11. 只查看name字段


```sql
select name from stu;
```

12. 将homedir表记录值改为beijing


```sql
date stu set homedir="beijing";
select * from stu;
```

13. 删除表记录

```sql
delete from stu;
```

14. 删除stu表

```sql
drop table stu;
```

### 案例3：练习数据类型的使用
1. 根据如下的表结构创建对应的表并插入记录

表-1

| Field    | Type        | Null | Key  | Default | Extra |
| -------- | ----------- | ---- | ---- | ------- | ----- |
| name     | char(5)     | YES  |      | NULL    |       |
| mail     | varchar(10) | YES  |      | NULL    |       |
| homeaddr | varchar(50) | YES  |      | NULL    |       |


表-2

| Field   | Type       | Null | Key  | Default | Extra |
| ------- | ---------- | ---- | ---- | ------- | ----- |
| stu_num | int(11)    | YES  |      | NULL    |       |
| name    | char(5)    | YES  |      | NULL    |       |
| age     | tinyint(4) | YES  |      | NULL    |       |
| pay     | float      | YES  |      | NULL    |       |
| money   | float(5,2) | YES  |      | NULL    |       |

表-3

| Field     | Type     | Null | Key  | Default | Extra |
| --------- | -------- | ---- | ---- | ------- | ----- |
| name      | char(10) | YES  |      | NULL    |       |
| you_start | year(4)  | YES  |      | NULL    |       |
| up_time   | time     | YES  |      | NULL    |       |
| birthday  | date     | YES  |      | NULL    |       |
| party     | datetime | YES  |      | NULL    |       |

表-4

| Field | Type                             | Null | Key  | Default | Extra |
| ----- | -------------------------------- | ---- | ---- | ------- | ----- |
| name  | char(5)                          | YES  |      | NULL    |       |
| likes | set('cat','game','film','music') | YES  |      | NULL    |       |
| sex   | enum('boy','girl','no')          | YES  |      | NULL    |       |

注：表3插入记录要求如下：
1. 所有字段值自定义

    ```sql
    create table b1(name char(5), mail varchar(10), homeaddr varchar(50));
    create table b2(stu_num int(11), name char(5), age tinyint(4), pay float, money float(5,2));
    create table b3(name char(10), you_start year(4), up_time time, birthday date, party datetime);
    create table b4(name char(5), likes set(`cat`,`game`,`film`,`music`), sex enum(`boy`,`girl`,`no`));
    ```

2. 用时间函数进行赋值

    ```sql
    insert into b3 values('tom', year(now()), time(now()), curdate(), now());
    ```

### 案例4：表结构练习
1. 按照表结构创建如下表，并插入记录

    ```sql
    create table b5(class char(9) DEFAULT NULL, name char(10) NOT NULL DEFAULT '', age tinyint(4) NOT NULL DEFAULT 19, likes set('a','b','c','d') DEFAULT 'a,b');
    ```

2. 只给class字段和name字段赋值

    ```sql
    insert into b5(class,name) values('class1','name1');
    ```

3. 在age字段后面添加字段值为性别（sex），默认值为boy

    ```sql
    alter table b5 add sex enum('boy', 'girl') default 'boy' after age;
    ```

4. 在表最前面添加学号（stu_id）字段

    ```sql
    alter table b5 add stu_id int(11) first;
    ```

5. 添加邮箱（email）字段，该字段不允许为空，默认值tarena@tedu.cn

    ```sql
    alte b5 add email varchar(30) not null default 'tarena@tedu.cn';
    ```

6. 修改sex字段类型，默认值为man

    ```sql
    alter table b5 modify sex enum('man','boy','girl') default 'man' after age;
    desc b5;
    ```

7. 将email字段移到age字段后面，其他属性不变
   
    ```sql
    alter table b5 modify email varchar(30) not null default 'tarena@tedu.cn' after age;
    ```

8. 删除表字段email和stu_id

    ```sql
    alter table b5 drop email,drop stu_id;
    ```

9. 将该表名改为abc

    ```sql
    rename table b5 to abc;
    ```
    
    
## 6.18练习

环境准备

1. 将虚拟机A开机
2. 关闭防火墙和SELinux

    ```shell
    systemctl stop firewalld.service 
    setenforce 0
    ```

3. 配置IP地址为192.168.4.10

    ```shell
    nmcli connection modify ens33 ipv4.method manual ipv4.addresses 192.168.4.10/24 connection.autoconnect yes 
    nmcli connection up ens33 
    ```

4. 配置本地yum源

    ```shell
    mount /dev/cdrom /mnt
    echo "[mnt]
    	name=Centos7.5
    	baseurl=file:///mnt
    	enabled=1
    	gpgcheck=0" > /etc/yum.repos.d/mnt.repo
    
    ls /etc/yum.repos.d/
    mkdir /etc/yum.repos.d/bind
    mv /etc/yum.repos.d/bind
    mv /etc/yum.repos.d/CentOS-* /etc/yum.repos.d/bind
    ls /etc/yum.repos.d/
    yum repolist
    ```

5. 构建mysql数据库

    ```shell
    systemctl stop firewalld.service 
    setenforce 0
    tar -xf mysql-5.7.17.tar
    yum -y install mysql-community-*.rpm
    systemctl start mysqld
    systemctl enable mysqld
    ```

6. 数据库管理员密码设置为123qqq...A

```shell
vim /etc/my.cnf
	validate_password_policy=0
	validate_password_length=6

grep password /var/log/mysqld.log
```

```sql
mysql -uroot -p'mysqld.log中的密码'
	show variables like "%password%"; 1
	set global validate_password_policy=0;
	set global validate_password_length=6;
	alter user root@localhost identified by "123qqq...A";
	exit
mysql -uroot -p123qqq...A
```


​    
​    
    练习:


1. 用命令行的形式连接到数据库

```sql
mysql -uroot -p123qqq...A
```

2. 在test库下创建一个user表

```sql
 show variables like '%file%'; --查看文件默认的检索目录 system ls /var/lib/mysql-files; --在mysql下执行Linux系统命令 exit
修改检索目录 vim /etc/my.cnf secure_file_priv="/myload"
mkdir /myload chown mysql /myload/ ls -ld /myload systemctl restart mysqld mysql -uroot -p'123qqq...A' show variables like '%file%';
数据导入：把系统文件的内容存储到数据库的表里，默认只有数据库管理员root用户有数据导入权限 数据导入步骤： 1、建表 2、拷贝文件到检索目录下 3、导入数据
语法格式：load data infile "/目录名/文件名" into table 库名.表名 fields terminated by "分隔符" lines terminated by "\n";
use test; create table test.user( name char(50),password char(1),uid int,gid int,comment varchar(150),homedir char(100),shell char(50)); desc user; select * from user; system cp /etc/passwd /myload; system ls /myload;
passwd
load data infile "/myload/passwd" into table user fields terminated by ":" lines terminated by "\n"; select * from user;
为了方便管理，在user表的最前面设置行号字段id（主键和自增长）
alter table user add id int primary key auto_increment first; select * from user;
```

3. 把存放用户信息的文件导入到test库下的user表

```sql
load data infile "/目录名/文件名" into table 库名.表名 fields terminated by "分隔符" lines terminated by "\n";
use test; create table test.user( name char(50),password char(1),uid int,gid int,comment varchar(150),homedir char(100),shell char(50)); desc user; select * from user; system cp /etc/passwd /myload; system ls /myload;
```



## 6.21 练习

环境准备
1. 将虚拟机svr7开机
2. 关闭SELiunx和防火墙

    ```shell
    systemctl stop firewalld.service 
    setenforce 0
    ```

3. 构建MySQL数据库

    ```shell
    tar -xf mysql-5.7.17.tar
    yum -y install mysql-community-*.rpm
    rpm -qa | grep mysql
    systemctl start mysqld
    systemctl enable mysqld
    netstat -anptu | grep :3306
    ls /var/lib/mysql
    ```

4. 数据库管理员密码设置为123qq..A

```shell
vim /etc/my.cnf
	validate_password_policy=0
	validate_password_length=6

grep password /var/log/mysqld.log
```

```sql
mysql -uroot -p'mysqld.log中的密码'
	show variables like "%password%"; 
	set global validate_password_policy=0;
	set global validate_password_length=6;
	alter user root@localhost identified by "123qq..A";
	exit
mysql -uroot -p123qq..A
```

5. 将/etc/passwd文件导入到test.user

```sql
show variables like '%file%';		-- 查看文件默认的检索目录
system ls /var/lib/mysql-files;		-- 在mysql下执行Linux系统命令
exit
```

```shell
# 修改检索目录
vim /etc/my.cnf
	secure_file_priv="/myload"

mkdir /myload
chown mysql /myload/
ls -ld /myload
systemctl restart mysqld
mysql -uroot -p123qq..A
	show variables like '%file%';

create database test;
use test;
create table test.user( name char(50),password char(1),uid int,gid int,comment varchar(150),homedir char(100),shell char(50));
desc user;
select * from user;
system cp /etc/passwd /myload;
system ls /myload;

load data infile "/myload/passwd" into table user fields terminated by ":" lines terminated by "\n";
select * from user;
```

6. 往user表里添加新字段id,设置类型为自增长

    ```sql
    alter table user add id int primary key auto_increment first;
    desc user;
    ```

7. 给name字段添加4条记录分别为(null,"null,",NULL)

    ```sql
    insert into user(name) values(null),("null"),(""),(NULL);
    select * from user;
    ```
    
    





## 6.22 练习

1. 构建mysql数据库，管理员密码为123qqq…A创建一个名为test库，将/etc/passwd文件导入到test.user

```shell
systemctl stop firewalld.service 
setenforce 0

tar -xf mysql-5.7.17.tar
yum -y install mysql-community-*.rpm
rpm -qa | grep mysql
systemctl start mysqld
systemctl enable mysqld
netstat -anptu | grep :3306
ls /var/lib/mysql

grep password /var/log/mysqld.log
```

```sql
mysql -uroot -p'mysqld.log中的密码'
	show variables like "%password%"; 
	set global validate_password_policy=0;
	set global validate_password_length=6;
	alter user root@localhost identified by "123qqq...A";
	exit
mysql -uroot -p123qqq...A
exit
```

```sql
vim /etc/my.cnf
	secure_file_priv="/myload"
cat /etc/my.cnf

mkdir /myload
chown mysql /myload/
ls -ld /myload
systemctl restart mysqld
mysql -uroot -p123qqq...A
	show variables like '%file%';

	create database test;
	show databases;
	use test;
	create table test.user( name char(50),password char(1),uid int,gid int,comment varchar(150),homedir char(100),shell char(50));
	desc user;
	select * from user;
	system cp /etc/passwd /myload;
	system ls /myload;
	system chown mysql /myload;
	load data infile "/myload/passwd" into table user fields terminated by ":" lines terminated by "\n";
	select * from user;
```

2. 在用户名字段下方添加s_year字段 存放出生年份 默认值是1990

```sql
alter table user add s_year year default 1990 after name;
```

3. 在用户名字段下方添加字段名sex 字段值只能是gril 或boy 默认值是 boy

```sql
alter table user add sex enum('girl','boy') default 'boy' after name;
```

4. 在sex字段下方添加 age字段  存放年龄 不允许输入负数。默认值 是 21

```sql
alter table user add age tinyint unsigned default 21 after sex;
```

5. 把uid字段值是10到50之间的用户的性别修改为 girl

```sql
update user set sex='girl' where uid between 10 and 50;
```

6. 统计性别是girl的用户有多少个。(count(*)统计个数)

```sql
select count(*) from user where sex="girl";
```

7. 查看性别是girl用户里 uid号 最大的用户名 叫什么。（看最大值用max）

```sql
select name from user where uid=(select max(uid) from user where sex='girl');
```

8. 添加一条新记录只给name、uid 字段赋值 值为rtestd  1000

```sql
insert into  user(name,uid) values("rtestd", 1000);
```

9. 加一条新记录只给name、uid 字段赋值 值为rtest2d   2000

```sql
insert into  user(name,uid) values("rtest2d", 2000);
```

10. 显示uid 是四位数的用户的用户名和uid值。

```sql
select name, uid from user where uid>=1000;
```

11. 显示名字是以字母r 开头 且是以字母d结尾的用户名和uid。

```sql
select name, uid from user where name regexp "^r.*d$"; 
```

12. 查看是否有名字以字母a开头 并且是以字母c结尾的用户。

```sql
select name, uid from user where name regexp "^a&c$"; 
```

13. 把 gid  在100到500间用户的家目录修改为/root

```sql
update user set comment='/root' where gid between 100 and 500;
```

14. 把用户是  root 、 bin 、  sync 用户的shell 修改为  /sbin/nologin

```sql
update user set shell='/sbin/nologin' where name in('root','bin','sync');
```

15. 查看  gid 小于10的用户 都使用那些shell

```sql
select shell from user where gid<10;
```

16. 删除  名字以字母d开头的用户。

```sql
delete from user where name regexp '^d';
```

17. 查看那些用户没有家目录

```sql
select name from user where lujing='/';
```

18. 使用系统命令useradd 命令添加登录系统的用户名为lucy

```sql
system useradd lucy;
system ls /home;
```

19. 把lucy用户的信息添加到user表里

```sql
system cat /etc/passwd
insert into user values('lucy',null,null,null,'x',1001,1001,null,'/home/lucy','/bin/bash');
```

20. 删除表中的 comment 字段

```sql
alter table user drop comment;
desc user;
```

21. 设置表中所有name字段值不允许为空

```sql
alter table user modify name char(50) not null;
```

22. 删除root用户家目录字段的值

```sql
update user set homedir=null where name='root';
```

23. 显示 gid 大于500的用户的用户名家目录和使用的shell

```sql
select name,homedir,shell from user where gid>500;
```

24. 删除uid大于100的用户记录

```sql
delete from user where uid>100;
```

25. 显示uid号在10到30区间的用户有多少个。

```sql
select count(*) from user where uid between 10 and 30;
```

26. 显示uid号是100以内的用户使用的shell。

```sql
select shell from user where uid<=100;
```

27. 显示uid号小于50且名字里有字母a 用户的详细信息

```sql
select * from user where  uid<50 and name like "%a%";
```

28. 只显示用户 root   bin   daemon  3个用户的详细信息。

```sql
select * from user where name in('root','bin','daemon');
```

29. 显示除root用户之外所有用户的详细信息。

```sql
select * from user where name!='root';
```

30. 显示名字里含字母c用户的详细信息

```sql
select * from user where name like '%c%';
```

31. 在sex字段下方添加名为pay的字段，用来存储工资，默认值15000.00

```sql
alter table user add pay float(7,2) default 15000.00 after sex;
```

32. 把所有女孩的工资修改为10000

```sql
update user set pay=10000.00 where sex='girl';
```

33. 把root用户的工资修改为30000

```sql
update user set pay=30000 where name='root';
```

34. 给adm用户涨500元工资

```sql
update user set pay=pay+500 where name='adm';
```

35. 查看所有用户的名字和工资

```sql
select name,pay from user;
```

36. 查看工资字段的平均值（平均值用avg）

```sql
select avg(pay) from user;
```

37. 显示工资字段值小于平均工资的用户名

```sql
select name from user where pay<(select avg(pay) from user);
```

38. 查看女生里uid号最大用户名

```sql
select name from user where  uid=(select max(uid) from user where sex='girl');
```

39. 查看bin用户的uid gid 字段的值 及 这2个字段相加的和

```sql
select uid,gid,uid+gid from user where name='bin';
```


40. 显示uid号最小的前10个用户的信息

```sql
select * from user order by uid limit 10;
```

41. 显示表中第10条记录到第15条记录

```sql
select * from user limit 9,5;
```

42. 统计name字段不为空有多少条记录

```sql
select count(*) from user where name is not null;
```











